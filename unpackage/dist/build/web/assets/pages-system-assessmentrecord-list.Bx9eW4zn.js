import{_ as e,e as t,n as a,q as n,N as s,aD as r,aF as i,O as o,s as l,r as d,a as c,c as u,w as g,i as h,b as m,d as f,f as p,g as b,o as _,h as y,k as C,l as S,m as k,F as w,I as x,p as I,t as D}from"./index-BQ2OFzYe.js";import{_ as T}from"./uni-stat-breadcrumb.DHkfubMW.js";import{_ as z}from"./uni-pagination.Bz9-uLqg.js";import{_ as $}from"./unicloud-db.C6t2K4BA.js";const v=t.database(),F=v.command;v.command.aggregate;const U=["recordId","name"],M={ascending:"asc",descending:"desc"};const q=e({data:()=>({query:"",where:"",orderby:"assessmentTime desc",orderByFieldName:"",selectedIndexs:[],options:{pageSize:20,pageCurrent:1,getone:!1,manual:!1},loading:!1,error:{message:""},data:[],userMap:new Map}),computed:{displayData(){return this.data.map((e=>({...e,nickname:this.userMap.get(e.userId)||"未知用户"})))}},mounted(){this.loadData()},methods:{formatTime(e){if(!e)return"-";const t=new Date(e);if(isNaN(t.getTime()))return"-";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`},formatDuration(e){if(!e&&0!==e)return"-";const t=Math.floor(e/60),a=Math.floor(e%60);return t>0?`${t}小时${a>0?a+"分钟":""}`:`${a}分钟`},async fetchUserNicknames(e){if(e.length)try{const{result:t}=await v.collection("User").where({userId:F.in([...new Set(e)])}).field("userId,nickname").get();t&&t.data&&(this.userMap=new Map(t.data.map((e=>[e.userId,e.nickname]))))}catch(t){console.error("获取用户昵称失败:",t)}},getWhere(){const e=this.query.trim();if(!e)return"";const t=new RegExp(e,"i");return F.or(U.map((e=>({[e]:t}))))},search(){const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},changeSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){var t;null==(t=this.$refs.udb)||t.loadData({clear:e})},onPageChanged(e){var t,a;this.selectedIndexs=[],null==(t=this.$refs.table)||t.clearSelection(),null==(a=this.$refs.udb)||a.loadData({current:e.current})},sortChange(e,t){var a;this.orderByFieldName=t,e.order?this.orderby=t+" "+M[e.order]:this.orderby="assessmentTime desc",null==(a=this.$refs.table)||a.clearSelection(),this.$nextTick((()=>{var e;null==(e=this.$refs.udb)||e.loadData()}))},async onqueryload(e){const t=Array.isArray(e)?e:e.data;if(!t||0===t.length)return void(this.data=[]);const a=t.map((e=>e.userId)).filter(Boolean);await this.fetchUserNicknames(a),this.data=t},navigateTo(e,t=!0){e&&a({url:e,events:{refreshData:()=>{this.loadData(t)}}})},async downloadFile(e){if(e.uploadUrl)try{s({title:"下载中..."});const a=(await t.getTempFileURL({fileList:[e.uploadUrl]})).fileList[0].tempFileURL;r({url:a,success:e=>{200===e.statusCode&&i({tempFilePath:e.tempFilePath,success:function(e){n({title:"下载成功",icon:"success"})}})},complete:()=>{o()}})}catch(a){console.error("下载失败:",a),n({title:"下载失败",icon:"error"}),o()}else n({title:"文件链接不存在",icon:"none"})},selectedItems(){return this.data&&this.selectedIndexs?this.selectedIndexs.map((e=>this.data[e]._id)).filter(Boolean):[]},async delTable(){const e=this.selectedItems();if(e.length)try{l({title:"提示",content:"是否确认删除选中的记录？",success:async t=>{var a;t.confirm&&(await v.collection("AssessmentRecord").where({_id:F.in(e)}).remove(),this.selectedIndexs=[],null==(a=this.$refs.table)||a.clearSelection(),this.loadData(!0),n({title:"删除成功",icon:"success"}))}})}catch(t){console.error("删除失败:",t),n({title:"删除失败",icon:"error"})}},selectionChange(e){var t;(null==(t=null==e?void 0:e.detail)?void 0:t.index)?this.selectedIndexs=e.detail.index:this.selectedIndexs=[]},async confirmDelete(e){if(e)try{l({title:"提示",content:"是否确认删除该记录？",success:async t=>{t.confirm&&(await v.collection("AssessmentRecord").doc(e).remove(),this.loadData(!0),n({title:"删除成功",icon:"success"}))}})}catch(t){console.error("删除失败:",t),n({title:"删除失败",icon:"error"})}}}},[["render",function(e,t,a,n,s,r){const i=d(c("uni-stat-breadcrumb"),T),o=x,l=I,v=h,F=d(c("uni-th"),m),U=d(c("uni-tr"),f),M=d(c("uni-td"),p),q=d(c("uni-table"),b),N=d(c("uni-pagination"),z),L=d(c("unicloud-db"),$);return _(),u(v,{class:"fix-top-window"},{default:g((()=>[y(v,{class:"uni-header"},{default:g((()=>[y(i,{class:"uni-stat-breadcrumb-on-phone"}),y(v,{class:"uni-group"},{default:g((()=>[y(o,{class:"uni-search",type:"text",modelValue:s.query,"onUpdate:modelValue":t[0]||(t[0]=e=>s.query=e),onConfirm:r.search,placeholder:"搜索记录..."},null,8,["modelValue","onConfirm"]),y(l,{class:"uni-button hide-on-phone",type:"default",size:"mini",onClick:r.search},{default:g((()=>[C("搜索")])),_:1},8,["onClick"]),y(l,{class:"uni-button",type:"warn",size:"mini",disabled:!s.selectedIndexs.length,onClick:r.delTable},{default:g((()=>[C("批量删除")])),_:1},8,["disabled","onClick"])])),_:1})])),_:1}),y(v,{class:"uni-container"},{default:g((()=>[y(L,{ref:"udb",collection:"AssessmentRecord",field:"recordId,userId,name,score,assessmentTime,duration,totaltoken,uploadUrl",where:s.where,"page-data":"replace",getcount:!0,"page-size":s.options.pageSize,"page-current":s.options.pageCurrent,orderby:s.orderby,loadtime:"manual",onLoad:r.onqueryload},{default:g((({pagination:e,loading:a,error:n})=>[y(q,{ref:"table",loading:a,emptyText:n.message||"没有数据",border:"",stripe:"",type:"selection",onSelectionChange:r.selectionChange},{default:g((()=>[y(U,null,{default:g((()=>[y(F,{align:"center",sortable:"",onSortChange:t[1]||(t[1]=e=>r.sortChange(e,"recordId"))},{default:g((()=>[C("记录ID")])),_:1}),y(F,{align:"center"},{default:g((()=>[C("用户昵称")])),_:1}),y(F,{align:"center",sortable:"",onSortChange:t[2]||(t[2]=e=>r.sortChange(e,"name"))},{default:g((()=>[C("主播姓名")])),_:1}),y(F,{align:"center",sortable:"",onSortChange:t[3]||(t[3]=e=>r.sortChange(e,"score"))},{default:g((()=>[C("得分")])),_:1}),y(F,{align:"center",sortable:"",onSortChange:t[4]||(t[4]=e=>r.sortChange(e,"assessmentTime"))},{default:g((()=>[C("评估时间")])),_:1}),y(F,{align:"center",sortable:"",onSortChange:t[5]||(t[5]=e=>r.sortChange(e,"duration"))},{default:g((()=>[C("持续时间")])),_:1}),y(F,{align:"center",sortable:"",onSortChange:t[6]||(t[6]=e=>r.sortChange(e,"totaltoken"))},{default:g((()=>[C("Token数")])),_:1}),y(F,{align:"center"},{default:g((()=>[C("操作")])),_:1})])),_:1}),(_(!0),S(w,null,k(r.displayData,((e,t)=>(_(),u(U,{key:t},{default:g((()=>[y(M,{align:"center"},{default:g((()=>[C(D(e.recordId||"-"),1)])),_:2},1024),y(M,{align:"center"},{default:g((()=>[C(D(e.nickname||"-"),1)])),_:2},1024),y(M,{align:"center"},{default:g((()=>[C(D(e.name||"-"),1)])),_:2},1024),y(M,{align:"center"},{default:g((()=>[C(D(e.score?e.score.toFixed(2):"-"),1)])),_:2},1024),y(M,{align:"center"},{default:g((()=>[C(D(r.formatTime(e.assessmentTime)),1)])),_:2},1024),y(M,{align:"center"},{default:g((()=>[C(D(r.formatDuration(e.duration)),1)])),_:2},1024),y(M,{align:"center"},{default:g((()=>[C(D(e.totaltoken?e.totaltoken.toFixed(0):"0"),1)])),_:2},1024),y(M,{align:"center"},{default:g((()=>[y(v,{class:"uni-group"},{default:g((()=>[y(l,{onClick:t=>r.navigateTo("./detail?id="+e._id,!0),class:"uni-button",size:"mini",type:"primary"},{default:g((()=>[C("详情")])),_:2},1032,["onClick"]),y(l,{onClick:t=>r.downloadFile(e),class:"uni-button",size:"mini",type:"default"},{default:g((()=>[C("下载")])),_:2},1032,["onClick"]),y(l,{onClick:t=>r.confirmDelete(e._id),class:"uni-button",size:"mini",type:"warn"},{default:g((()=>[C("删除")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1032,["loading","emptyText","onSelectionChange"]),y(v,{class:"uni-pagination-box"},{default:g((()=>[y(N,{"show-icon":"","show-page-size":"","page-size":e.size,current:e.current,"onUpdate:current":t=>e.current=t,total:e.count,onChange:r.onPageChanged,onPageSizeChange:r.changeSize},null,8,["page-size","current","onUpdate:current","total","onChange","onPageSizeChange"])])),_:2},1024)])),_:1},8,["where","page-size","page-current","orderby","onLoad"])])),_:1})])),_:1})}],["__scopeId","data-v-0480b3ad"]]);export{q as default};
