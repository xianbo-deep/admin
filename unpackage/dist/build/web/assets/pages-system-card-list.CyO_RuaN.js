import{_ as t,e,q as a,s,r as i,a as n,c as l,w as o,i as c,a5 as d,o as u,h as r,l as f,m as g,F as m,k as p,t as h,v as _,p as C,I as b,K as y,A as S,V as T}from"./index-1tsbwzWw.js";import{_ as k}from"./uni-stat-breadcrumb.gfsZYonB.js";const w=e.database(),v=w.command.aggregate,N=[{value:"daily",label:"日卡"},{value:"monthly",label:"月卡"},{value:"times",label:"次卡"}];const $=t({data:()=>({cardStats:{daily:{total:0,unused:0,used:0},monthly:{total:0,unused:0,used:0},times:{total:0,unused:0,used:0}},timeConfigs:[],currentConfig:{name:"",functionName:"",enabled:!1,updateTime:new Date},isEditing:!1,editIndex:-1}),mounted(){this.getCardStats(),this.getTimeConfigs()},methods:{async getCardStats(){try{const{result:t}=await w.collection("Card").aggregate().group({_id:{cardType:"$cardType",status:"$status"},count:v.sum(1)}).end();Object.keys(this.cardStats).forEach((t=>{this.cardStats[t]={total:0,unused:0,used:0}})),t.data.forEach((t=>{const e=t._id.cardType,a=t._id.status,s=t.count;this.cardStats[e]&&("unused"===a?this.cardStats[e].unused=s:"used"===a&&(this.cardStats[e].used=s),this.cardStats[e].total+=s)}))}catch(t){console.error("获取统计数据失败:",t)}},getCardTypeName(t){const e=N.find((e=>e.value===t));return e?e.label:t},getProgressWidth(t){if(!t.total)return"0%";return`${t.used/t.total*100}%`},async getTimeConfigs(){try{const{result:t}=await w.collection("TimeConfig").get();this.timeConfigs=t.data||[]}catch(t){console.error("获取定时任务配置失败:",t),a({title:"获取定时任务配置失败",icon:"none"})}},formatDate(t){if(!t)return"未更新";const e=new Date(t);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}`},showAddConfigModal(){this.isEditing=!1,this.currentConfig={name:"",functionName:"",enabled:!1,updateTime:new Date},this.$refs.configPopup.open()},editTimeConfig(t){this.isEditing=!0,this.editIndex=t;const e=JSON.parse(JSON.stringify(this.timeConfigs[t]));e.enabled=Boolean(e.enabled),this.currentConfig=e,this.$refs.configPopup.open()},closeConfigPopup(){this.$refs.configPopup.close()},async confirmSaveConfig(){try{if(!this.currentConfig.name.trim())return void a({title:"请输入任务名称",icon:"none"});if(!this.currentConfig.functionName.trim())return void a({title:"请输入云函数名称",icon:"none"});const t={name:this.currentConfig.name,functionName:this.currentConfig.functionName,enabled:!!this.isEditing&&this.timeConfigs[this.editIndex].enabled,updateTime:Date.now()};if(this.isEditing){const e=this.timeConfigs[this.editIndex]._id;await w.collection("TimeConfig").doc(e).update(t),this.timeConfigs[this.editIndex]={...t,_id:e},a({title:"更新成功",icon:"success"})}else{const{result:e}=await w.collection("TimeConfig").add(t);this.timeConfigs.push({...t,_id:e.id}),a({title:"添加成功",icon:"success"})}this.closeConfigPopup()}catch(t){console.error("保存定时任务配置失败:",t),console.error("错误详情:",JSON.stringify(t)),a({title:"保存失败: "+(t.message||"未知错误"),icon:"none",duration:3e3})}},async deleteTimeConfig(t){s({title:"确认删除",content:`确定要删除"${this.timeConfigs[t].name}"吗？`,success:async e=>{if(e.confirm)try{const e=this.timeConfigs[t]._id;await w.collection("TimeConfig").doc(e).remove(),this.timeConfigs.splice(t,1),a({title:"删除成功",icon:"success"})}catch(s){console.error("删除定时任务配置失败:",s),a({title:"删除失败",icon:"none"})}}})},async toggleTaskStatus(t){try{const e=this.timeConfigs[t],s=!e.enabled;await w.collection("TimeConfig").doc(e._id).update({enabled:s,updateTime:Date.now()}),this.timeConfigs[t].enabled=s,this.timeConfigs[t].updateTime=Date.now(),a({title:s?"已启用":"已禁用",icon:"success"})}catch(e){console.error("更新任务状态失败:",e),a({title:"操作失败",icon:"none"})}}}},[["render",function(t,e,a,s,w,v){const N=i(n("uni-stat-breadcrumb"),k),$=c,D=_,E=T,P=C,x=b,I=i(n("uni-popup"),d);return u(),l($,{class:"statistics-container"},{default:o((()=>[r($,{class:"statistics-area"},{default:o((()=>[r(N,{class:"uni-stat-breadcrumb-on-phone"}),r($,{class:"stat-cards"},{default:o((()=>[(u(!0),f(m,null,g(w.cardStats,((t,e)=>(u(),l($,{class:"stat-card",key:e},{default:o((()=>[r($,{class:"stat-title"},{default:o((()=>[p(h(v.getCardTypeName(e)),1)])),_:2},1024),r($,{class:"stat-content"},{default:o((()=>[r($,{class:"stat-item"},{default:o((()=>[r(D,{class:"label"},{default:o((()=>[p("总数量")])),_:1}),r(D,{class:"number"},{default:o((()=>[p(h(t.total||0),1)])),_:2},1024)])),_:2},1024),r($,{class:"stat-progress-bar"},{default:o((()=>[r($,{class:"progress",style:y({width:v.getProgressWidth(t)})},null,8,["style"])])),_:2},1024),r($,{class:"stat-details"},{default:o((()=>[r($,{class:"detail-item"},{default:o((()=>[r(D,{class:"sub-label"},{default:o((()=>[p("已使用")])),_:1}),r(D,{class:"sub-number used"},{default:o((()=>[p(h(t.used||0),1)])),_:2},1024)])),_:2},1024),r($,{class:"detail-item"},{default:o((()=>[r(D,{class:"sub-label"},{default:o((()=>[p("未使用")])),_:1}),r(D,{class:"sub-number unused"},{default:o((()=>[p(h(t.unused||0),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1}),r($,{class:"time-config-section"},{default:o((()=>[r($,{class:"section-title"},{default:o((()=>[p("定时任务管理")])),_:1}),r($,{class:"time-config-cards"},{default:o((()=>[(u(!0),f(m,null,g(w.timeConfigs,((t,e)=>(u(),l($,{class:"time-config-card",key:e},{default:o((()=>[r($,{class:"config-header"},{default:o((()=>[r($,{class:"config-name"},{default:o((()=>[p(h(t.name),1)])),_:2},1024),r(E,{checked:t.enabled,onChange:t=>v.toggleTaskStatus(e),color:"#409EFF"},null,8,["checked","onChange"])])),_:2},1024),r($,{class:"config-details"},{default:o((()=>[r($,{class:"config-item"},{default:o((()=>[r(D,{class:"config-label"},{default:o((()=>[p("云函数:")])),_:1}),r(D,{class:"config-value"},{default:o((()=>[p(h(t.functionName),1)])),_:2},1024)])),_:2},1024),r($,{class:"config-item"},{default:o((()=>[r(D,{class:"config-label"},{default:o((()=>[p("状态:")])),_:1}),r(D,{class:S(["config-value",t.enabled?"status-enabled":"status-disabled"])},{default:o((()=>[p(h(t.enabled?"已启用":"已禁用"),1)])),_:2},1032,["class"])])),_:2},1024),r($,{class:"config-item"},{default:o((()=>[r(D,{class:"config-label"},{default:o((()=>[p("更新时间:")])),_:1}),r(D,{class:"config-value"},{default:o((()=>[p(h(v.formatDate(t.updateTime)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),r($,{class:"config-actions"},{default:o((()=>[r(P,{class:"action-btn edit-btn",onClick:t=>v.editTimeConfig(e)},{default:o((()=>[p("编辑")])),_:2},1032,["onClick"]),r(P,{class:"action-btn delete-btn",onClick:t=>v.deleteTimeConfig(e)},{default:o((()=>[p("删除")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)))),128))])),_:1}),r($,{class:"add-config-container"},{default:o((()=>[r(P,{class:"add-config-btn",onClick:v.showAddConfigModal},{default:o((()=>[p("添加定时任务")])),_:1},8,["onClick"])])),_:1}),r(I,{ref:"configPopup",type:"dialog"},{default:o((()=>[r($,{class:"custom-popup"},{default:o((()=>[r($,{class:"popup-header"},{default:o((()=>[r(D,{class:"popup-title"},{default:o((()=>[p(h(w.isEditing?"编辑定时任务":"添加定时任务"),1)])),_:1})])),_:1}),r($,{class:"popup-form"},{default:o((()=>[r($,{class:"form-item"},{default:o((()=>[r(D,{class:"form-label"},{default:o((()=>[p("任务名称")])),_:1}),r(x,{class:"form-input",modelValue:w.currentConfig.name,"onUpdate:modelValue":e[0]||(e[0]=t=>w.currentConfig.name=t),placeholder:"请输入定时任务名称"},null,8,["modelValue"])])),_:1}),r($,{class:"form-item"},{default:o((()=>[r(D,{class:"form-label"},{default:o((()=>[p("云函数名称")])),_:1}),r(x,{class:"form-input",modelValue:w.currentConfig.functionName,"onUpdate:modelValue":e[1]||(e[1]=t=>w.currentConfig.functionName=t),placeholder:"请输入云函数名称"},null,8,["modelValue"])])),_:1})])),_:1}),r($,{class:"popup-footer"},{default:o((()=>[r(P,{class:"popup-btn cancel-btn",onClick:v.closeConfigPopup},{default:o((()=>[p("取消")])),_:1},8,["onClick"]),r(P,{class:"popup-btn confirm-btn",onClick:v.confirmSaveConfig},{default:o((()=>[p("确定")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1},512)])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-28aab50d"]]);export{$ as default};
