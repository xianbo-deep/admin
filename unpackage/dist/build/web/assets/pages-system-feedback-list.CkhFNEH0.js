import{_ as e,e as t,a1 as a,q as n,s as i,r as s,a as r,c as o,w as l,i as d,b as c,d as u,f as m,g,o as h,h as f,k as p,l as b,m as _,F as y,I as k,p as C,t as I,j as S}from"./index-BQ2OFzYe.js";import{_ as w}from"./uni-stat-breadcrumb.DHkfubMW.js";import{_ as T}from"./uni-tag.AKI94Qn2.js";import{_ as x}from"./uni-pagination.Bz9-uLqg.js";import{_ as D}from"./unicloud-db.C6t2K4BA.js";const $=t.database(),z=$.command;$.command.aggregate;const M=["feedbackId","content","contact"],N={ascending:"asc",descending:"desc"};const F=e({data:()=>({query:"",where:"",orderby:"submitTime desc",orderByFieldName:"",selectedIndexs:[],options:{pageSize:20,pageCurrent:1,getone:!1,manual:!1},loading:!1,error:{message:""},data:[],userMap:new Map,adminMap:new Map}),computed:{displayData(){return this.data.map((e=>({...e,nickname:this.userMap.get(e.userId)||"未知用户",adminNickname:this.adminMap.get(e.adminId)||"-",formattedSubmitTime:this.formatTime(e.submitTime),formattedProcessTime:e.processTime?this.formatTime(e.processTime):"未处理"})))}},mounted(){this.loadData()},methods:{formatTime(e){if(!e)return"-";const t=Number(e);if(isNaN(t))return"-";const a=new Date(t);if(isNaN(a.getTime()))return"-";return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}:${String(a.getSeconds()).padStart(2,"0")}`},getWhere(){const e=this.query.trim();if(!e)return"";const t=new RegExp(e,"i");return $.command.or(M.map((e=>({[e]:t}))))},search(){const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},changeSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb&&this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs=[],this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},sortChange(e,t){this.orderByFieldName=t,e.order?this.orderby=t+" "+N[e.order]:this.orderby="submitTime desc",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},async onqueryload(e){console.log("当前管理员:",a.userInfo),console.log("加载的数据:",e);const t=Array.isArray(e)?e:e.data;if(!t||0===t.length)return void this.$set(this,"data",[]);const n=t.map((e=>({...e,submitTime:e.submitTime?Number(e.submitTime):Date.now(),processTime:e.processTime?Number(e.processTime):null}))),i=[...new Set(n.map((e=>e.userId)))],s=[...new Set(n.map((e=>e.adminId)).filter(Boolean))];try{if(i.length>0){const e=await $.collection("User").where({userId:z.in(i)}).field("userId,nickname").get();this.userMap=new Map(e.result.data.map((e=>[e.userId,e.nickname])))}if(s.length>0){const e=await $.collection("Admin").where({adminId:z.in(s)}).field("adminId,nickname").get();this.adminMap=new Map(e.result.data.map((e=>[e.adminId,e.nickname])))}this.$set(this,"data",n)}catch(r){console.error("获取用户或管理员信息失败:",r),this.$set(this,"data",n)}},async handleProcess(e){if(!e||!e._id)return;const t=a.userInfo._id,s=a.userInfo.username;t&&s?i({title:"提示",content:"确认处理该反馈？",success:async a=>{if(a.confirm)try{const a=Date.now();await $.collection("Feedback").doc(e._id).update({status:"processed",processTime:a,adminId:t}),this.loadData(!0),n({title:"处理成功",icon:"success"})}catch(i){console.error("处理失败:",i),n({title:"处理失败",icon:"error"})}}}):n({title:"请先登录",icon:"none"})},selectedItems(){return this.data&&this.selectedIndexs?this.selectedIndexs.map((e=>this.data[e]._id)).filter(Boolean):[]},async delTable(){const e=this.selectedItems();if(e.length)try{i({title:"提示",content:"是否确认删除选中的反馈？",success:async t=>{var a;t.confirm&&(await $.collection("Feedback").where({_id:z.in(e)}).remove(),this.selectedIndexs=[],null==(a=this.$refs.table)||a.clearSelection(),this.loadData(!0),n({title:"删除成功",icon:"success"}))}})}catch(t){console.error("删除失败:",t),n({title:"删除失败",icon:"error"})}},selectionChange(e){e&&e.detail&&Array.isArray(e.detail.index)&&(this.selectedIndexs=e.detail.index)},async confirmDelete(e){if(e)try{i({title:"提示",content:"是否确认删除该反馈？",success:async t=>{t.confirm&&(await $.collection("Feedback").doc(e).remove(),this.loadData(!0),n({title:"删除成功",icon:"success"}))}})}catch(t){console.error("删除失败:",t),n({title:"删除失败",icon:"error"})}}}},[["render",function(e,t,a,n,i,$){const z=s(r("uni-stat-breadcrumb"),w),M=k,N=C,F=d,P=s(r("uni-th"),c),q=s(r("uni-tr"),u),V=s(r("uni-td"),m),j=s(r("uni-tag"),T),v=s(r("uni-table"),g),A=s(r("uni-pagination"),x),B=s(r("unicloud-db"),D);return h(),o(F,{class:"fix-top-window"},{default:l((()=>[f(F,{class:"uni-header"},{default:l((()=>[f(z,{class:"uni-stat-breadcrumb-on-phone"}),f(F,{class:"uni-group"},{default:l((()=>[f(M,{class:"uni-search",type:"text",modelValue:i.query,"onUpdate:modelValue":t[0]||(t[0]=e=>i.query=e),onConfirm:$.search,placeholder:"搜索反馈..."},null,8,["modelValue","onConfirm"]),f(N,{class:"uni-button hide-on-phone",type:"default",size:"mini",onClick:$.search},{default:l((()=>[p("搜索")])),_:1},8,["onClick"]),f(N,{class:"uni-button",type:"warn",size:"mini",disabled:!i.selectedIndexs.length,onClick:$.delTable},{default:l((()=>[p("批量删除")])),_:1},8,["disabled","onClick"])])),_:1})])),_:1}),f(F,{class:"uni-container"},{default:l((()=>[f(B,{ref:"udb",collection:"Feedback",field:"feedbackId,userId,submitTime,content,status,processTime,adminId,contact,feedbacktype",where:i.where,"page-data":"replace",getcount:!0,"page-size":i.options.pageSize,"page-current":i.options.pageCurrent,orderby:i.orderby,loadtime:"manual",onLoad:$.onqueryload},{default:l((({pagination:e,loading:a,error:n})=>[f(v,{ref:"table",loading:a,emptyText:n.message||"没有数据",border:"",stripe:"",type:"selection",onSelectionChange:$.selectionChange},{default:l((()=>[f(q,null,{default:l((()=>[f(P,{align:"center",sortable:"",onSortChange:t[1]||(t[1]=e=>$.sortChange(e,"feedbackId"))},{default:l((()=>[p("反馈ID")])),_:1}),f(P,{align:"center"},{default:l((()=>[p("用户昵称")])),_:1}),f(P,{align:"center"},{default:l((()=>[p("联系方式")])),_:1}),f(P,{align:"center",sortable:"",onSortChange:t[2]||(t[2]=e=>$.sortChange(e,"feedbacktype"))},{default:l((()=>[p("反馈类型")])),_:1}),f(P,{align:"center"},{default:l((()=>[p("反馈内容")])),_:1}),f(P,{align:"center",sortable:"",onSortChange:t[3]||(t[3]=e=>$.sortChange(e,"submitTime"))},{default:l((()=>[p("提交时间")])),_:1}),f(P,{align:"center",sortable:"",onSortChange:t[4]||(t[4]=e=>$.sortChange(e,"processTime"))},{default:l((()=>[p("处理时间")])),_:1}),f(P,{align:"center",sortable:"",onSortChange:t[5]||(t[5]=e=>$.sortChange(e,"status"))},{default:l((()=>[p("状态")])),_:1}),f(P,{align:"center"},{default:l((()=>[p("处理人")])),_:1}),f(P,{align:"center"},{default:l((()=>[p("操作")])),_:1})])),_:1}),(h(!0),b(y,null,_($.displayData,((e,t)=>(h(),o(q,{key:e._id},{default:l((()=>[f(V,{align:"center"},{default:l((()=>[f(F,{class:"ellipsis",title:e.feedbackId},{default:l((()=>[p(I(e.feedbackId),1)])),_:2},1032,["title"])])),_:2},1024),f(V,{align:"center"},{default:l((()=>[f(F,{class:"ellipsis",title:e.nickname},{default:l((()=>[p(I(e.nickname),1)])),_:2},1032,["title"])])),_:2},1024),f(V,{align:"center"},{default:l((()=>[p(I(e.contact),1)])),_:2},1024),f(V,{align:"center"},{default:l((()=>[p(I(e.feedbacktype),1)])),_:2},1024),f(V,{align:"center"},{default:l((()=>[f(F,{class:"ellipsis",title:e.content},{default:l((()=>[p(I(e.content),1)])),_:2},1032,["title"])])),_:2},1024),f(V,{align:"center"},{default:l((()=>[p(I(e.formattedSubmitTime),1)])),_:2},1024),f(V,{align:"center"},{default:l((()=>[p(I(e.formattedProcessTime),1)])),_:2},1024),f(V,{align:"center"},{default:l((()=>[f(j,{text:"pending"===e.status?"待处理":"已处理",type:"pending"===e.status?"warning":"success"},null,8,["text","type"])])),_:2},1024),f(V,{align:"center"},{default:l((()=>[f(F,{class:"ellipsis",title:e.adminNickname},{default:l((()=>[p(I(e.adminNickname),1)])),_:2},1032,["title"])])),_:2},1024),f(V,{align:"center"},{default:l((()=>[f(F,{class:"uni-group"},{default:l((()=>["pending"===e.status?(h(),o(N,{key:0,onClick:t=>$.handleProcess(e),class:"uni-button",size:"mini",type:"primary"},{default:l((()=>[p("处理")])),_:2},1032,["onClick"])):S("",!0),f(N,{onClick:t=>$.confirmDelete(e._id),class:"uni-button",size:"mini",type:"warn"},{default:l((()=>[p("删除")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1032,["loading","emptyText","onSelectionChange"]),f(F,{class:"uni-pagination-box"},{default:l((()=>[f(A,{"show-icon":"","show-page-size":"","page-size":e.size,modelValue:e.current,"onUpdate:modelValue":t=>e.current=t,total:e.count,onChange:$.onPageChanged,onPageSizeChange:$.changeSize},null,8,["page-size","modelValue","onUpdate:modelValue","total","onChange","onPageSizeChange"])])),_:2},1024)])),_:1},8,["where","page-size","page-current","orderby","onLoad"])])),_:1})])),_:1})}],["__scopeId","data-v-af1fbf5a"]]);export{F as default};
