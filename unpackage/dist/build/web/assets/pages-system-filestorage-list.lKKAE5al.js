import{_ as e,e as t,q as a,N as n,aE as i,O as s,aF as l,s as o,r,a as d,c,w as u,i as g,b as h,d as f,f as m,g as p,o as b,h as y,k as _,l as C,m as S,F as w,I,p as k,t as x}from"./index-1tsbwzWw.js";import{_ as T}from"./uni-stat-breadcrumb.gfsZYonB.js";import{_ as z}from"./uni-pagination.DVZKLAsf.js";import{_ as D}from"./unicloud-db.DwiPvpWe.js";const $=t.database(),U=$.command;$.command.aggregate;const F=["fileId","fileUrl"],N={ascending:"asc",descending:"desc"};const V=e({data:()=>({query:"",where:"",orderby:"uploadTime desc",orderByFieldName:"",selectedIndexs:[],options:{pageSize:20,pageCurrent:1,getone:!1,manual:!1},loading:!1,error:{message:""},data:[],userMap:new Map}),computed:{displayData(){return this.data.map((e=>({...e,nickname:this.userMap.get(e.userId)||"未知用户"})))}},mounted(){this.loadData()},methods:{formatTime(e){if(!e)return"-";const t=Number(e);if(isNaN(t))return"-";const a=new Date(t);if(isNaN(a.getTime()))return"-";return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`},async fetchUserNicknames(e){if(e.length)try{const{result:t}=await $.collection("User").where({userId:U.in([...new Set(e)])}).field("userId,nickname").get();t&&t.data&&(this.userMap=new Map(t.data.map((e=>[e.userId,e.nickname]))))}catch(t){console.error("获取用户昵称失败:",t)}},getWhere(){const e=this.query.trim();if(!e)return"";const t=new RegExp(e,"i");return $.command.or(F.map((e=>({[e]:t}))))},search(){const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},changeSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb&&this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs=[],this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},sortChange(e,t){this.orderByFieldName=t,e.order?this.orderby=t+" "+N[e.order]:this.orderby="uploadTime desc",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},async onqueryload(e){const t=Array.isArray(e)?e:e.data;if(!t||0===t.length)return void this.$set(this,"data",[]);const a=t.map((e=>({...e,uploadTime:e.uploadTime?Number(e.uploadTime):Date.now()}))),n=a.map((e=>e.userId)).filter(Boolean);await this.fetchUserNicknames(n),this.$set(this,"data",a)},downloadVideo(e){e.fileUrl?(n({title:"准备下载..."}),i({url:e.fileUrl,success:e=>{200===e.statusCode&&(s(),l({filePath:e.tempFilePath,success:function(e){console.log("文件打开成功")},fail:function(e){console.error("打开文件失败:",e),a({title:"打开文件失败",icon:"none"})}}))},fail:e=>{console.error("下载失败:",e),s(),a({title:"下载失败",icon:"none"})}})):a({title:"下载链接不可用",icon:"none"})},selectedItems(){return this.data&&this.selectedIndexs?this.selectedIndexs.map((e=>this.data[e]._id)).filter(Boolean):[]},async delTable(){const e=this.selectedItems();if(e.length)try{o({title:"提示",content:"是否确认删除选中的视频？",success:async t=>{var n;if(t.confirm){const t=e.map((e=>$.collection("FileStorage").doc(e).remove()));await Promise.all(t),this.selectedIndexs=[],null==(n=this.$refs.table)||n.clearSelection(),this.loadData(!0),a({title:"删除成功",icon:"success"})}}})}catch(t){console.error("删除失败:",t),a({title:"删除失败",icon:"error"})}},selectionChange(e){e&&e.detail&&Array.isArray(e.detail.index)&&(this.selectedIndexs=e.detail.index)},async confirmDelete(e){if(e)try{o({title:"提示",content:"是否确认删除该视频？",success:async t=>{t.confirm&&(await $.collection("FileStorage").doc(e).remove(),this.loadData(!0),a({title:"删除成功",icon:"success"}))}})}catch(t){console.error("删除失败:",t),a({title:"删除失败",icon:"error"})}}}},[["render",function(e,t,a,n,i,s){const l=r(d("uni-stat-breadcrumb"),T),o=I,$=k,U=g,F=r(d("uni-th"),h),N=r(d("uni-tr"),f),V=r(d("uni-td"),m),q=r(d("uni-table"),p),M=r(d("uni-pagination"),z),P=r(d("unicloud-db"),D);return b(),c(U,{class:"fix-top-window"},{default:u((()=>[y(U,{class:"uni-header"},{default:u((()=>[y(l,{class:"uni-stat-breadcrumb-on-phone"}),y(U,{class:"uni-group"},{default:u((()=>[y(o,{class:"uni-search",type:"text",modelValue:i.query,"onUpdate:modelValue":t[0]||(t[0]=e=>i.query=e),onConfirm:s.search,placeholder:"搜索视频..."},null,8,["modelValue","onConfirm"]),y($,{class:"uni-button hide-on-phone",type:"default",size:"mini",onClick:s.search},{default:u((()=>[_("搜索")])),_:1},8,["onClick"]),y($,{class:"uni-button",type:"warn",size:"mini",disabled:!i.selectedIndexs.length,onClick:s.delTable},{default:u((()=>[_("批量删除")])),_:1},8,["disabled","onClick"])])),_:1})])),_:1}),y(U,{class:"uni-container"},{default:u((()=>[y(P,{ref:"udb",collection:"FileStorage",field:"fileId,userId,fileUrl,fileFormat,uploadTime",where:i.where,"page-data":"replace",getcount:!0,"page-size":i.options.pageSize,"page-current":i.options.pageCurrent,orderby:i.orderby,loadtime:"manual",onLoad:s.onqueryload},{default:u((({pagination:e,loading:a,error:n})=>[y(q,{ref:"table",loading:a,emptyText:n.message||"没有数据",border:"",stripe:"",type:"selection",onSelectionChange:s.selectionChange},{default:u((()=>[y(N,null,{default:u((()=>[y(F,{align:"center",sortable:"",onSortChange:t[1]||(t[1]=e=>s.sortChange(e,"fileId"))},{default:u((()=>[_("文件ID")])),_:1}),y(F,{align:"center"},{default:u((()=>[_("用户昵称")])),_:1}),y(F,{align:"center"},{default:u((()=>[_("视频URL")])),_:1}),y(F,{align:"center",sortable:"",onSortChange:t[2]||(t[2]=e=>s.sortChange(e,"fileFormat"))},{default:u((()=>[_("格式")])),_:1}),y(F,{align:"center",sortable:"",onSortChange:t[3]||(t[3]=e=>s.sortChange(e,"uploadTime"))},{default:u((()=>[_("上传时间")])),_:1}),y(F,{align:"center"},{default:u((()=>[_("操作")])),_:1})])),_:1}),(b(!0),C(w,null,S(s.displayData,((e,t)=>(b(),c(N,{key:e._id},{default:u((()=>[y(V,{align:"center"},{default:u((()=>[y(U,{class:"ellipsis",title:e.fileId},{default:u((()=>[_(x(e.fileId),1)])),_:2},1032,["title"])])),_:2},1024),y(V,{align:"center"},{default:u((()=>[y(U,{class:"ellipsis",title:e.nickname},{default:u((()=>[_(x(e.nickname),1)])),_:2},1032,["title"])])),_:2},1024),y(V,{align:"center"},{default:u((()=>[y(U,{class:"ellipsis",title:e.fileUrl},{default:u((()=>[_(x(e.fileUrl),1)])),_:2},1032,["title"])])),_:2},1024),y(V,{align:"center"},{default:u((()=>[_(x(e.fileFormat),1)])),_:2},1024),y(V,{align:"center"},{default:u((()=>[_(x(s.formatTime(e.uploadTime)),1)])),_:2},1024),y(V,{align:"center"},{default:u((()=>[y(U,{class:"uni-group"},{default:u((()=>[y($,{onClick:t=>s.downloadVideo(e),class:"uni-button",size:"mini",type:"default"},{default:u((()=>[_("下载")])),_:2},1032,["onClick"]),y($,{onClick:t=>s.confirmDelete(e._id),class:"uni-button",size:"mini",type:"warn"},{default:u((()=>[_("删除")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1032,["loading","emptyText","onSelectionChange"]),y(U,{class:"uni-pagination-box"},{default:u((()=>[y(M,{"show-icon":"","show-page-size":"","page-size":e.size,modelValue:e.current,"onUpdate:modelValue":t=>e.current=t,total:e.count,onChange:s.onPageChanged,onPageSizeChange:s.changeSize},null,8,["page-size","modelValue","onUpdate:modelValue","total","onChange","onPageSizeChange"])])),_:2},1024)])),_:1},8,["where","page-size","page-current","orderby","onLoad"])])),_:1})])),_:1})}],["__scopeId","data-v-c0ae7581"]]);export{V as default};
