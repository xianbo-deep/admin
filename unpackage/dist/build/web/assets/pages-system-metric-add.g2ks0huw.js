import{_ as e,e as a,s as t,N as i,q as s,H as n,O as r,r as c,a as o,c as l,w as d,i as g,o as m,h as u,k as f,t as p,v as h,M as I,p as k}from"./index-1tsbwzWw.js";import{_}from"./uni-easyinput.B-y-wvYA.js";import{_ as D}from"./uni-forms-item.C04_D_PQ.js";import{_ as w}from"./uni-forms.Cx-ojO0j.js";const x=a.database();const y=e({data:()=>({id:"",packageList:[],packageIndex:-1,agentList:[],agentIndex:-1,formData:{metricId:"",packageId:"",metricname:"",agentId:"",description:""},rules:{metricId:{rules:[{required:!0,errorMessage:"请输入指标ID"},{pattern:"^[a-zA-Z0-9_-]+$",errorMessage:"指标ID只能包含字母、数字、下划线和连字符"}]},packageId:{rules:[{required:!0,errorMessage:"请选择套餐"}]},agentId:{rules:[{required:!0,errorMessage:"请选择代理"}]},metricname:{rules:[{required:!0,errorMessage:"请输入指标名称"}]}}}),async onLoad(e){await Promise.all([this.getPackageList(),this.getAgentList()]),e.id&&(this.id=e.id,this.getDetail())},methods:{async getPackageList(){try{const e=await x.collection("Package").get();e.result&&e.result.data&&(this.packageList=e.result.data,console.log("获取到的套餐列表:",this.packageList))}catch(e){console.error("获取套餐列表错误:",e),t({content:"获取套餐列表失败",showCancel:!1})}},async getAgentList(){try{const e=await x.collection("Agent").where('status == "normal"').get();e.result&&e.result.data&&(this.agentList=e.result.data,console.log("获取到的代理列表:",this.agentList))}catch(e){console.error("获取代理列表错误:",e),t({content:"获取代理列表失败",showCancel:!1})}},onPackageChange(e){const a=e.detail.value;this.packageIndex=a;const t=this.packageList[a];t&&(this.formData.packageId=t.package_id.toString())},onAgentChange(e){const a=e.detail.value;this.agentIndex=a;const t=this.agentList[a];t&&(this.formData.agentId=t.agentId)},getPackageName(e){const a=this.packageList.find((a=>a.package_id.toString()===e));return a?`${a.package_name} (${a.package_id})`:"请选择套餐"},getAgentIdentifier(e){const a=this.agentList.find((a=>a.agentId===e));return a?a.identifier:"请选择代理"},async submitForm(){try{if(!(await this.$refs.form.validate()))return;i({title:this.id?"修改中...":"新增中..."});const a={metricId:this.formData.metricId.trim(),packageId:this.formData.packageId,metricname:this.formData.metricname.trim(),agentId:this.formData.agentId,description:this.formData.description||""};if(this.id)await x.collection("Metric").doc(this.id).update(a),s({title:"修改成功"});else try{if((await x.collection("Metric").where("metricId == $1",[a.metricId]).get()).result.data.length>0)return void t({content:"指标ID已存在",showCancel:!1});await x.collection("Metric").add(a),s({title:"新增成功"})}catch(e){return void t({content:e.message||"新增失败",showCancel:!1})}this.getOpenerEventChannel().emit("refreshData"),setTimeout((()=>n()),500)}catch(a){t({content:a.message||"操作失败",showCancel:!1})}finally{r()}},async getDetail(){try{i({mask:!0});const e=(await x.collection("Metric").doc(this.id).field("metricId,packageId,metricname,agentId,description").get()).result.data[0];e&&(this.formData=e,this.packageIndex=this.packageList.findIndex((a=>a.package_id.toString()===e.packageId)),this.agentIndex=this.agentList.findIndex((a=>a.agentId===e.agentId)))}catch(e){t({content:e.message||"获取详情失败",showCancel:!1})}finally{r()}},goBack(){n()}}},[["render",function(e,a,t,i,s,n){const r=c(o("uni-easyinput"),_),x=c(o("uni-forms-item"),D),y=h,C=g,L=I,b=k,v=c(o("uni-forms"),w);return m(),l(C,{class:"container"},{default:d((()=>[u(v,{ref:"form",model:s.formData,rules:s.rules},{default:d((()=>[u(x,{label:"指标ID",name:"metricId",required:""},{default:d((()=>[u(r,{modelValue:s.formData.metricId,"onUpdate:modelValue":a[0]||(a[0]=e=>s.formData.metricId=e),placeholder:"请输入指标ID",disabled:!!s.id},null,8,["modelValue","disabled"])])),_:1}),u(x,{label:"套餐",name:"packageId",required:""},{default:d((()=>[u(C,{class:"select-box"},{default:d((()=>[u(L,{onChange:n.onPackageChange,value:s.packageIndex,range:s.packageList,"range-key":"package_name"},{default:d((()=>[u(C,{class:"picker-box"},{default:d((()=>[u(y,{class:"picker-text"},{default:d((()=>[f(p(s.formData.packageId?n.getPackageName(s.formData.packageId):"请选择套餐"),1)])),_:1}),u(y,{class:"picker-arrow"},{default:d((()=>[f("▼")])),_:1})])),_:1})])),_:1},8,["onChange","value","range"])])),_:1})])),_:1}),u(x,{label:"代理",name:"agentId",required:""},{default:d((()=>[u(C,{class:"select-box"},{default:d((()=>[u(L,{onChange:n.onAgentChange,value:s.agentIndex,range:s.agentList,"range-key":"identifier"},{default:d((()=>[u(C,{class:"picker-box"},{default:d((()=>[u(y,{class:"picker-text"},{default:d((()=>[f(p(s.formData.agentId?n.getAgentIdentifier(s.formData.agentId):"请选择代理"),1)])),_:1}),u(y,{class:"picker-arrow"},{default:d((()=>[f("▼")])),_:1})])),_:1})])),_:1},8,["onChange","value","range"])])),_:1})])),_:1}),u(x,{label:"指标名称",name:"metricname",required:""},{default:d((()=>[u(r,{modelValue:s.formData.metricname,"onUpdate:modelValue":a[1]||(a[1]=e=>s.formData.metricname=e),placeholder:"请输入指标名称"},null,8,["modelValue"])])),_:1}),u(x,{label:"描述",name:"description"},{default:d((()=>[u(r,{type:"textarea",modelValue:s.formData.description,"onUpdate:modelValue":a[2]||(a[2]=e=>s.formData.description=e),placeholder:"请输入描述信息"},null,8,["modelValue"])])),_:1}),u(C,{class:"btn-group"},{default:d((()=>[u(b,{onClick:n.submitForm,type:"primary",class:"btn"},{default:d((()=>[f("提交")])),_:1},8,["onClick"]),u(b,{onClick:n.goBack,class:"btn"},{default:d((()=>[f("返回")])),_:1},8,["onClick"])])),_:1})])),_:1},8,["model","rules"])])),_:1})}],["__scopeId","data-v-d16f0571"]]);export{y as default};
