import{_ as e,e as a,s as t,N as s,O as n,q as i,H as r,r as o,a as l,c,w as d,i as g,o as m,h as u,k as f,t as h,M as p,p as I,Z as k}from"./index-1tsbwzWw.js";import{_ as D}from"./uni-easyinput.B-y-wvYA.js";import{_}from"./uni-forms-item.C04_D_PQ.js";import{_ as b}from"./uni-forms.Cx-ojO0j.js";const y=a.database();const w=e({data:()=>({formDataId:"",packageList:[],packageIndex:-1,agentList:[],agentIndex:-1,formData:{metricId:"",packageId:"",agentId:"",metricname:"",description:""},rules:{metricId:{rules:[{required:!0,errorMessage:"请输入指标ID"},{pattern:"^[a-zA-Z0-9]+$",errorMessage:"指标ID只能包含字母和数字"}]},packageId:{rules:[{required:!0,errorMessage:"请选择套餐"}]},agentId:{rules:[{required:!0,errorMessage:"请选择代理"}]},metricname:{rules:[{required:!0,errorMessage:"请输入指标名称"}]}}}),async onLoad(e){await Promise.all([this.getPackageList(),this.getAgentList()]),e.id&&(this.formDataId=e.id,this.getDetail(e.id))},methods:{async getPackageList(){try{const e=await y.collection("Package").get();if(!e.result||!e.result.data)throw new Error("未获取到套餐数据");this.packageList=e.result.data,console.log("获取到的套餐列表:",this.packageList)}catch(e){console.error("获取套餐列表错误:",e),t({content:"获取套餐列表失败: "+(e.message||"未知错误"),showCancel:!1})}},async getAgentList(){try{const e=await y.collection("Agent").where('status == "normal"').get();if(!e.result||!e.result.data)throw new Error("未获取到代理数据");this.agentList=e.result.data,console.log("获取到的代理列表:",this.agentList)}catch(e){console.error("获取代理列表错误:",e),t({content:"获取代理列表失败: "+(e.message||"未知错误"),showCancel:!1})}},onPackageChange(e){const a=e.detail.value;this.packageIndex=a;const t=this.packageList[a];t&&(this.formData.packageId=t.package_id.toString(),console.log("选中的套餐:",t))},onAgentChange(e){const a=e.detail.value;this.agentIndex=a;const t=this.agentList[a];t&&(this.formData.agentId=t.agentId,console.log("选中的代理:",t))},getPackageName(e){const a=this.packageList.find((a=>a.package_id.toString()===e));return a?`${a.package_name} (${a.package_id})`:"请选择套餐"},getAgentIdentifier(e){const a=this.agentList.find((a=>a.agentId===e));return a?a.identifier:"请选择代理"},submitForm(){this.$refs.form.submit()},submit(e){const{value:a,errors:i}=e.detail;i||(s({title:this.formDataId?"修改中...":"新增中...",mask:!0}),this.formDataId?this.submitData(a):y.collection("Metric").where("metricId == $1",[a.metricId]).get().then((e=>{e.result.data.length>0?(t({content:"指标ID已存在",showCancel:!1}),n()):this.submitData(a)})).catch((e=>{n(),t({content:e.message||"请求服务失败",showCancel:!1})})))},submitData(e){["metricId","metricname"].forEach((a=>{e[a]&&(e[a]=e[a].trim())})),this.formDataId?y.collection("Metric").doc(this.formDataId).update(e).then((()=>{i({title:"修改成功"}),this.getOpenerEventChannel().emit("refreshData"),setTimeout((()=>r()),500)})).catch((e=>{t({content:e.message||"请求服务失败",showCancel:!1})})).finally((()=>{n()})):y.collection("Metric").add(e).then((()=>{i({title:"新增成功"}),this.getOpenerEventChannel().emit("refreshData"),setTimeout((()=>r()),500)})).catch((e=>{t({content:e.message||"请求服务失败",showCancel:!1})})).finally((()=>{n()}))},async getDetail(e){s({mask:!0});try{const a=(await y.collection("Metric").doc(e).field("metricId,packageId,agentId,metricname,description").get()).result.data[0];a&&(this.formData=Object.assign({},this.formData,a),this.packageIndex=this.packageList.findIndex((e=>e.package_id.toString()===a.packageId)),this.agentIndex=this.agentList.findIndex((e=>e.agentId===a.agentId)))}catch(a){t({content:a.message||"请求服务失败",showCancel:!1})}finally{n()}}}},[["render",function(e,a,t,s,n,i){const r=o(l("uni-easyinput"),D),y=o(l("uni-forms-item"),_),w=g,C=p,L=I,x=k,v=o(l("uni-forms"),b);return m(),c(w,{class:"uni-container"},{default:d((()=>[u(v,{ref:"form",modelValue:n.formData,"onUpdate:modelValue":a[3]||(a[3]=e=>n.formData=e),rules:n.rules,validateTrigger:"bind",onSubmit:i.submit},{default:d((()=>[u(y,{name:"metricId",label:"指标ID",required:""},{default:d((()=>[u(r,{modelValue:n.formData.metricId,"onUpdate:modelValue":a[0]||(a[0]=e=>n.formData.metricId=e),clearable:!1,placeholder:"请输入指标ID",disabled:!!n.formDataId},null,8,["modelValue","disabled"])])),_:1}),u(y,{name:"packageId",label:"套餐",required:""},{default:d((()=>[u(w,{class:"select-box"},{default:d((()=>[u(C,{onChange:i.onPackageChange,value:n.packageIndex,range:n.packageList,"range-key":"package_name"},{default:d((()=>[u(w,{class:"picker-item"},{default:d((()=>[f(h(n.formData.packageId?i.getPackageName(n.formData.packageId):"请选择套餐"),1)])),_:1})])),_:1},8,["onChange","value","range"])])),_:1})])),_:1}),u(y,{name:"agentId",label:"代理",required:""},{default:d((()=>[u(w,{class:"select-box"},{default:d((()=>[u(C,{onChange:i.onAgentChange,value:n.agentIndex,range:n.agentList,"range-key":"identifier"},{default:d((()=>[u(w,{class:"picker-item"},{default:d((()=>[f(h(n.formData.agentId?i.getAgentIdentifier(n.formData.agentId):"请选择代理"),1)])),_:1})])),_:1},8,["onChange","value","range"])])),_:1})])),_:1}),u(y,{name:"metricname",label:"指标名称",required:""},{default:d((()=>[u(r,{modelValue:n.formData.metricname,"onUpdate:modelValue":a[1]||(a[1]=e=>n.formData.metricname=e),clearable:!1,placeholder:"请输入指标名称"},null,8,["modelValue"])])),_:1}),u(y,{name:"description",label:"描述"},{default:d((()=>[u(r,{type:"textarea",modelValue:n.formData.description,"onUpdate:modelValue":a[2]||(a[2]=e=>n.formData.description=e),placeholder:"请输入描述"},null,8,["modelValue"])])),_:1}),u(w,{class:"uni-button-group"},{default:d((()=>[u(L,{style:{width:"100px"},type:"primary",class:"uni-button",onClick:i.submitForm},{default:d((()=>[f("提交")])),_:1},8,["onClick"]),u(x,{"open-type":"navigateBack",style:{"margin-left":"15px"}},{default:d((()=>[u(L,{style:{width:"100px"},class:"uni-button"},{default:d((()=>[f("返回")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue","rules","onSubmit"])])),_:1})}],["__scopeId","data-v-aa5902bf"]]);export{w as default};
