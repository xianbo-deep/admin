import{_ as e,e as a,n as t,s as n,q as i,r as s,a as o,c as r,w as l,i as d,b as c,d as u,f as h,g,o as m,h as p,k as f,l as b,m as y,F as _,I as C,p as I,t as x}from"./index-1tsbwzWw.js";import{_ as w}from"./uni-stat-breadcrumb.gfsZYonB.js";import{_ as k}from"./uni-pagination.DVZKLAsf.js";import{_ as z}from"./unicloud-db.DwiPvpWe.js";const D=a.database(),S=D.command,$=["metricId","packageId","agentId","metricname","description"],T={ascending:"asc",descending:"desc"};const v=e({data:()=>({query:"",where:"",orderby:"metricId asc",orderByFieldName:"",selectedIndexs:[],options:{pageSize:20,pageCurrent:1,getone:!1,manual:!1},data:[]}),computed:{displayData(){return this.data||[]}},mounted(){this.loadData()},methods:{getWhere(){const e=this.query.trim();if(!e)return"";const a=new RegExp(e,"i");return S.or($.map((e=>({[e]:a}))))},search(){const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},changeSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb&&this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs=[],this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},sortChange(e,a){this.orderByFieldName=a,e.order?this.orderby=a+" "+T[e.order]:this.orderby="metricId asc",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},async onqueryload(e){const a=Array.isArray(e)?e:e.data;a&&0!==a.length?this.$set(this,"data",a):this.$set(this,"data",[])},navigateTo(e,a=!0){e&&t({url:e,events:{refreshData:()=>{this.loadData(a)}}})},selectedItems(){return this.data&&this.selectedIndexs?this.selectedIndexs.map((e=>this.data[e]._id)).filter(Boolean):[]},async delTable(){const e=this.selectedItems();if(e.length)try{n({title:"提示",content:"是否确认删除选中的记录？",success:async a=>{var t;if(a.confirm){const a=await D.startTransaction();try{const n=e.map((e=>a.collection("Metric").doc(e).remove()));await Promise.all(n),await a.commit(),this.selectedIndexs=[],null==(t=this.$refs.table)||t.clearSelection(),this.loadData(!0),i({title:"删除成功",icon:"success"})}catch(n){throw await a.rollback(),n}}}})}catch(a){console.error("删除失败:",a),i({title:"删除失败",icon:"error"})}},selectionChange(e){e&&e.detail&&Array.isArray(e.detail.index)&&(this.selectedIndexs=e.detail.index)},async confirmDelete(e){if(e)try{n({title:"提示",content:"是否确认删除该记录？",success:async a=>{a.confirm&&(await D.collection("Metric").doc(e).remove(),this.loadData(!0),i({title:"删除成功",icon:"success"}))}})}catch(a){console.error("删除失败:",a),i({title:"删除失败",icon:"error"})}}}},[["render",function(e,a,t,n,i,D){const S=s(o("uni-stat-breadcrumb"),w),$=C,T=I,v=d,q=s(o("uni-th"),c),V=s(o("uni-tr"),u),P=s(o("uni-td"),h),j=s(o("uni-table"),g),A=s(o("uni-pagination"),k),B=s(o("unicloud-db"),z);return m(),r(v,{class:"fix-top-window"},{default:l((()=>[p(v,{class:"uni-header"},{default:l((()=>[p(S,{class:"uni-stat-breadcrumb-on-phone"}),p(v,{class:"uni-group"},{default:l((()=>[p($,{class:"uni-search",type:"text",modelValue:i.query,"onUpdate:modelValue":a[0]||(a[0]=e=>i.query=e),onConfirm:D.search,placeholder:"搜索指标..."},null,8,["modelValue","onConfirm"]),p(T,{class:"uni-button hide-on-phone",type:"default",size:"mini",onClick:D.search},{default:l((()=>[f("搜索")])),_:1},8,["onClick"]),p(T,{class:"uni-button",type:"primary",size:"mini",onClick:a[1]||(a[1]=e=>D.navigateTo("./add"))},{default:l((()=>[f("新增")])),_:1}),p(T,{class:"uni-button",type:"warn",size:"mini",disabled:!i.selectedIndexs.length,onClick:D.delTable},{default:l((()=>[f("批量删除")])),_:1},8,["disabled","onClick"])])),_:1})])),_:1}),p(v,{class:"uni-container"},{default:l((()=>[p(B,{ref:"udb",collection:"Metric",where:i.where,"page-data":"replace",getcount:!0,"page-size":i.options.pageSize,"page-current":i.options.pageCurrent,orderby:i.orderby,loadtime:"manual",onLoad:D.onqueryload},{default:l((({pagination:e,loading:t,error:n})=>[p(j,{ref:"table",loading:t,emptyText:n.message||"没有数据",border:"",stripe:"",type:"selection",onSelectionChange:D.selectionChange},{default:l((()=>[p(V,null,{default:l((()=>[p(q,{align:"center",sortable:"",onSortChange:a[2]||(a[2]=e=>D.sortChange(e,"metricId"))},{default:l((()=>[f("指标ID")])),_:1}),p(q,{align:"center",sortable:"",onSortChange:a[3]||(a[3]=e=>D.sortChange(e,"packageId"))},{default:l((()=>[f("套餐ID")])),_:1}),p(q,{align:"center",sortable:"",onSortChange:a[4]||(a[4]=e=>D.sortChange(e,"agentId"))},{default:l((()=>[f("代理ID")])),_:1}),p(q,{align:"center",sortable:"",onSortChange:a[5]||(a[5]=e=>D.sortChange(e,"metricname"))},{default:l((()=>[f("指标名称")])),_:1}),p(q,{align:"center"},{default:l((()=>[f("描述")])),_:1}),p(q,{align:"center"},{default:l((()=>[f("操作")])),_:1})])),_:1}),(m(!0),b(_,null,y(D.displayData,((e,a)=>(m(),r(V,{key:a},{default:l((()=>[p(P,{align:"center"},{default:l((()=>[f(x(e.metricId),1)])),_:2},1024),p(P,{align:"center"},{default:l((()=>[f(x(e.packageId),1)])),_:2},1024),p(P,{align:"center"},{default:l((()=>[f(x(e.agentId),1)])),_:2},1024),p(P,{align:"center"},{default:l((()=>[f(x(e.metricname),1)])),_:2},1024),p(P,{align:"center"},{default:l((()=>[f(x(e.description),1)])),_:2},1024),p(P,{align:"center"},{default:l((()=>[p(v,{class:"uni-group"},{default:l((()=>[p(T,{onClick:a=>D.navigateTo("./edit?id="+e._id,!1),class:"uni-button",size:"mini",type:"primary"},{default:l((()=>[f("编辑")])),_:2},1032,["onClick"]),p(T,{onClick:a=>D.confirmDelete(e._id),class:"uni-button",size:"mini",type:"warn"},{default:l((()=>[f("删除")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1032,["loading","emptyText","onSelectionChange"]),p(v,{class:"uni-pagination-box"},{default:l((()=>[p(A,{"show-icon":"","show-page-size":"","page-size":e.size,modelValue:e.current,"onUpdate:modelValue":a=>e.current=a,total:e.count,onChange:D.onPageChanged,onPageSizeChange:D.changeSize},null,8,["page-size","modelValue","onUpdate:modelValue","total","onChange","onPageSizeChange"])])),_:2},1024)])),_:1},8,["where","page-size","page-current","orderby","onLoad"])])),_:1})])),_:1})}],["__scopeId","data-v-6b7c171b"]]);export{v as default};
