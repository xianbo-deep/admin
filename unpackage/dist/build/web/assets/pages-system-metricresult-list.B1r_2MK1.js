import{_ as e,e as t,n as a,s as n,q as i,r,a as s,c as l,w as o,i as d,b as c,d as u,f as g,g as h,o as m,h as f,k as p,l as _,m as b,F as y,I as C,p as S,t as T}from"./index-BQ2OFzYe.js";import{_ as I}from"./uni-stat-breadcrumb.DHkfubMW.js";import{_ as x}from"./uni-pagination.Bz9-uLqg.js";import{_ as k}from"./unicloud-db.C6t2K4BA.js";const D=t.database(),v=D.command;D.command.aggregate;const $=["resultId","recordId"],w={ascending:"asc",descending:"desc"};const z=e({data:()=>({query:"",where:"",orderby:"evaluationTime desc",orderByFieldName:"",selectedIndexs:[],options:{pageSize:20,pageCurrent:1,getone:!1,manual:!1},loading:!1,error:{message:""},data:[]}),computed:{displayData(){return this.data.map((e=>({...e,formattedEvaluationTime:this.formatTime(e.evaluationTime),averageScore:this.calculateAverageScore(e.metrics),totalTokens:this.calculateTotalTokens(e.metrics)})))}},mounted(){this.loadData()},methods:{formatTime(e){if(!e)return"-";const t=new Date(e);if(isNaN(t.getTime()))return"-";return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`},calculateAverageScore(e){if(!e||!e.length)return 0;return e.reduce(((e,t)=>e+(t.score||0)),0)/e.length},calculateTotalTokens:e=>e&&e.length?e.reduce(((e,t)=>e+(t.token||0)),0):0,getWhere(){const e=this.query.trim();if(!e)return"";const t=new RegExp(e,"i");return D.command.or($.map((e=>({[e]:t}))))},search(){const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},changeSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb&&this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs=[],this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},sortChange(e,t){this.orderByFieldName=t,e.order?this.orderby=t+" "+w[e.order]:this.orderby="evaluationTime desc",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},async onqueryload(e){const t=Array.isArray(e)?e:e.data;t&&0!==t.length?this.$set(this,"data",t):this.$set(this,"data",[])},navigateTo(e,t=!0){e&&a({url:e,events:{refreshData:()=>{this.loadData(t)}}})},selectedItems(){return this.data&&this.selectedIndexs?this.selectedIndexs.map((e=>this.data[e]._id)).filter(Boolean):[]},async delTable(){const e=this.selectedItems();if(e.length)try{n({title:"提示",content:"是否确认删除选中的评估结果？",success:async t=>{var a;t.confirm&&(await D.collection("MetricResult").where({_id:v.in(e)}).remove(),this.selectedIndexs=[],null==(a=this.$refs.table)||a.clearSelection(),this.loadData(!0),i({title:"删除成功",icon:"success"}))}})}catch(t){console.error("删除失败:",t),i({title:"删除失败",icon:"error"})}},selectionChange(e){e&&e.detail&&Array.isArray(e.detail.index)&&(this.selectedIndexs=e.detail.index)},async confirmDelete(e){if(e)try{n({title:"提示",content:"是否确认删除该评估结果？",success:async t=>{t.confirm&&(await D.collection("MetricResult").doc(e).remove(),this.loadData(!0),i({title:"删除成功",icon:"success"}))}})}catch(t){console.error("删除失败:",t),i({title:"删除失败",icon:"error"})}}}},[["render",function(e,t,a,n,i,D){const v=r(s("uni-stat-breadcrumb"),I),$=C,w=S,z=d,q=r(s("uni-th"),c),V=r(s("uni-tr"),u),A=r(s("uni-td"),g),F=r(s("uni-table"),h),M=r(s("uni-pagination"),x),j=r(s("unicloud-db"),k);return m(),l(z,{class:"fix-top-window"},{default:o((()=>[f(z,{class:"uni-header"},{default:o((()=>[f(v,{class:"uni-stat-breadcrumb-on-phone"}),f(z,{class:"uni-group"},{default:o((()=>[f($,{class:"uni-search",type:"text",modelValue:i.query,"onUpdate:modelValue":t[0]||(t[0]=e=>i.query=e),onConfirm:D.search,placeholder:"搜索评估结果..."},null,8,["modelValue","onConfirm"]),f(w,{class:"uni-button hide-on-phone",type:"default",size:"mini",onClick:D.search},{default:o((()=>[p("搜索")])),_:1},8,["onClick"]),f(w,{class:"uni-button",type:"warn",size:"mini",disabled:!i.selectedIndexs.length,onClick:D.delTable},{default:o((()=>[p("批量删除")])),_:1},8,["disabled","onClick"])])),_:1})])),_:1}),f(z,{class:"uni-container"},{default:o((()=>[f(j,{ref:"udb",collection:"MetricResult",field:"resultId,recordId,evaluationTime,metrics",where:i.where,"page-data":"replace",getcount:!0,"page-size":i.options.pageSize,"page-current":i.options.pageCurrent,orderby:i.orderby,loadtime:"manual",onLoad:D.onqueryload},{default:o((({pagination:e,loading:a,error:n})=>[f(F,{ref:"table",loading:a,emptyText:n.message||"没有数据",border:"",stripe:"",type:"selection",onSelectionChange:D.selectionChange},{default:o((()=>[f(V,null,{default:o((()=>[f(q,{align:"center",sortable:"",onSortChange:t[1]||(t[1]=e=>D.sortChange(e,"resultId"))},{default:o((()=>[p("评估ID")])),_:1}),f(q,{align:"center",sortable:"",onSortChange:t[2]||(t[2]=e=>D.sortChange(e,"recordId"))},{default:o((()=>[p("记录ID")])),_:1}),f(q,{align:"center",sortable:"",onSortChange:t[3]||(t[3]=e=>D.sortChange(e,"evaluationTime"))},{default:o((()=>[p("评估时间")])),_:1}),f(q,{align:"center"},{default:o((()=>[p("指标数量")])),_:1}),f(q,{align:"center"},{default:o((()=>[p("平均得分")])),_:1}),f(q,{align:"center"},{default:o((()=>[p("总Token")])),_:1}),f(q,{align:"center"},{default:o((()=>[p("操作")])),_:1})])),_:1}),(m(!0),_(y,null,b(D.displayData,((e,t)=>(m(),l(V,{key:e._id},{default:o((()=>[f(A,{align:"center"},{default:o((()=>[f(z,{class:"ellipsis",title:e.resultId},{default:o((()=>[p(T(e.resultId),1)])),_:2},1032,["title"])])),_:2},1024),f(A,{align:"center"},{default:o((()=>[f(z,{class:"ellipsis",title:e.recordId},{default:o((()=>[p(T(e.recordId),1)])),_:2},1032,["title"])])),_:2},1024),f(A,{align:"center"},{default:o((()=>[p(T(e.formattedEvaluationTime),1)])),_:2},1024),f(A,{align:"center"},{default:o((()=>[p(T(e.metrics.length),1)])),_:2},1024),f(A,{align:"center"},{default:o((()=>[p(T(e.averageScore.toFixed(2)),1)])),_:2},1024),f(A,{align:"center"},{default:o((()=>[p(T(e.totalTokens.toFixed(0)),1)])),_:2},1024),f(A,{align:"center"},{default:o((()=>[f(z,{class:"uni-group"},{default:o((()=>[f(w,{onClick:t=>D.navigateTo("./details?id="+e._id),class:"uni-button",size:"mini",type:"primary"},{default:o((()=>[p("详情")])),_:2},1032,["onClick"]),f(w,{onClick:t=>D.confirmDelete(e._id),class:"uni-button",size:"mini",type:"warn"},{default:o((()=>[p("删除")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1032,["loading","emptyText","onSelectionChange"]),f(z,{class:"uni-pagination-box"},{default:o((()=>[f(M,{"show-icon":"","show-page-size":"","page-size":e.size,modelValue:e.current,"onUpdate:modelValue":t=>e.current=t,total:e.count,onChange:D.onPageChanged,onPageSizeChange:D.changeSize},null,8,["page-size","modelValue","onUpdate:modelValue","total","onChange","onPageSizeChange"])])),_:2},1024)])),_:1},8,["where","page-size","page-current","orderby","onLoad"])])),_:1})])),_:1})}],["__scopeId","data-v-df6b3665"]]);export{z as default};
