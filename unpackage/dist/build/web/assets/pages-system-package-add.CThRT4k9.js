import{_ as e,e as t,s as a,N as s,q as i,H as l,O as c,r,a as o,c as n,w as d,i as m,a5 as u,o as f,h as p,k as _,t as h,l as g,m as k,F as D,v as M,M as b,p as v,Y as y,X as C,T as I}from"./index-1tsbwzWw.js";import{_ as w}from"./uni-easyinput.B-y-wvYA.js";import{_ as S}from"./uni-forms-item.C04_D_PQ.js";import{_ as x}from"./uni-forms.Cx-ojO0j.js";import{_ as V}from"./uni-popup-dialog.EWgTrJQg.js";const q=t.database(),j=[{value:"active",label:"启用"},{value:"inactive",label:"禁用"}];const L=e({data:()=>({id:"",statusIndex:0,statusOptions:j,availableMetrics:[],selectedMetricIds:[],formData:{package_id:"",package_name:"",description:"",status:"active",metrics:[]},rules:{package_id:{rules:[{required:!0,errorMessage:"请输入套餐ID"}]},package_name:{rules:[{required:!0,errorMessage:"请输入套餐名称"}]},status:{rules:[{required:!0,errorMessage:"请选择状态"}]}}}),async onLoad(e){await this.getMetricsList(),e.id&&(this.id=e.id,this.getDetail())},methods:{async getMetricsList(){try{const e=await q.collection("Metric").field("metricId,metricname,description").get();e.result&&e.result.data&&(this.availableMetrics=e.result.data)}catch(e){a({content:"获取指标列表失败",showCancel:!1})}},getStatusLabel(e){const t=j.find((t=>t.value===e));return t?t.label:"请选择状态"},onStatusChange(e){const t=e.detail.value;this.statusIndex=t,this.formData.status=j[t].value},showMetricSelector(){this.selectedMetricIds=this.formData.metrics.map((e=>e.metric_id)),this.$refs.metricSelector.open()},closeMetricSelector(){this.$refs.metricSelector.close()},onMetricSelect(e){this.selectedMetricIds=e.detail.value},isMetricSelected(e){return this.selectedMetricIds.includes(e)},confirmSelectMetrics(){const e=this.availableMetrics.filter((e=>this.selectedMetricIds.includes(e.metricId))).map((e=>({metric_id:e.metricId,metric_name:e.metricname})));this.formData.metrics=e,this.closeMetricSelector()},removeMetric(e){a({title:"提示",content:"确定要移除该指标吗？",success:t=>{t.confirm&&this.formData.metrics.splice(e,1)}})},async submitForm(){try{if(!(await this.$refs.form.validate()))return;if(0===this.formData.metrics.length)return void a({content:"请至少选择一个指标",showCancel:!1});s({title:this.id?"修改中...":"新增中..."});const e={package_id:parseInt(this.formData.package_id),package_name:this.formData.package_name.trim(),description:this.formData.description||"",status:this.formData.status,metrics:this.formData.metrics};if(this.id)await q.collection("Package").doc(this.id).update(e),i({title:"修改成功"});else{if((await q.collection("Package").where("package_id == $1",[e.package_id]).get()).result.data.length>0)throw new Error("套餐ID已存在");await q.collection("Package").add(e),i({title:"新增成功"})}this.getOpenerEventChannel().emit("refreshData"),setTimeout((()=>l()),500)}catch(e){a({content:e.message||"操作失败",showCancel:!1})}finally{c()}},async getDetail(){try{s({mask:!0});const e=(await q.collection("Package").doc(this.id).field("package_id,package_name,description,status,metrics").get()).result.data[0];e&&(this.formData=e,this.statusIndex=j.findIndex((t=>t.value===e.status)))}catch(e){a({content:e.message||"获取详情失败",showCancel:!1})}finally{c()}},goBack(){l()}}},[["render",function(e,t,a,s,i,l){const c=r(o("uni-easyinput"),w),q=r(o("uni-forms-item"),S),j=M,L=m,O=b,P=v,$=r(o("uni-forms"),x),z=C,B=I,F=y,U=r(o("uni-popup-dialog"),V),E=r(o("uni-popup"),u);return f(),n(L,{class:"container"},{default:d((()=>[p($,{ref:"form",model:i.formData,rules:i.rules},{default:d((()=>[p(q,{label:"套餐ID",name:"package_id",required:""},{default:d((()=>[p(c,{modelValue:i.formData.package_id,"onUpdate:modelValue":t[0]||(t[0]=e=>i.formData.package_id=e),type:"number",placeholder:"请输入套餐ID",disabled:!!i.id},null,8,["modelValue","disabled"])])),_:1}),p(q,{label:"套餐名称",name:"package_name",required:""},{default:d((()=>[p(c,{modelValue:i.formData.package_name,"onUpdate:modelValue":t[1]||(t[1]=e=>i.formData.package_name=e),placeholder:"请输入套餐名称"},null,8,["modelValue"])])),_:1}),p(q,{label:"描述",name:"description"},{default:d((()=>[p(c,{type:"textarea",modelValue:i.formData.description,"onUpdate:modelValue":t[2]||(t[2]=e=>i.formData.description=e),placeholder:"请输入描述信息"},null,8,["modelValue"])])),_:1}),p(q,{label:"状态",name:"status",required:""},{default:d((()=>[p(L,{class:"select-box"},{default:d((()=>[p(O,{onChange:l.onStatusChange,value:i.statusIndex,range:i.statusOptions,"range-key":"label"},{default:d((()=>[p(L,{class:"picker-box"},{default:d((()=>[p(j,{class:"picker-text"},{default:d((()=>[_(h(l.getStatusLabel(i.formData.status)),1)])),_:1}),p(j,{class:"picker-arrow"},{default:d((()=>[_("▼")])),_:1})])),_:1})])),_:1},8,["onChange","value","range"])])),_:1})])),_:1}),p(L,{class:"metrics-section"},{default:d((()=>[p(L,{class:"section-header"},{default:d((()=>[p(j,{class:"section-title"},{default:d((()=>[_("指标列表")])),_:1}),p(P,{onClick:l.showMetricSelector,type:"primary",size:"mini"},{default:d((()=>[_("添加指标")])),_:1},8,["onClick"])])),_:1}),i.formData.metrics.length?(f(),n(L,{key:0,class:"metrics-list"},{default:d((()=>[(f(!0),g(D,null,k(i.formData.metrics,((e,t)=>(f(),n(L,{key:e.metric_id,class:"metric-item"},{default:d((()=>[p(L,{class:"metric-info"},{default:d((()=>[p(j,{class:"metric-name"},{default:d((()=>[_(h(e.metric_name),1)])),_:2},1024),p(j,{class:"metric-id"},{default:d((()=>[_("("+h(e.metric_id)+")",1)])),_:2},1024)])),_:2},1024),p(P,{onClick:e=>l.removeMetric(t),type:"warn",size:"mini"},{default:d((()=>[_("移除")])),_:2},1032,["onClick"])])),_:2},1024)))),128))])),_:1})):(f(),n(L,{key:1,class:"empty-metrics"},{default:d((()=>[_(" 暂无指标，请添加 ")])),_:1}))])),_:1}),p(L,{class:"btn-group"},{default:d((()=>[p(P,{onClick:l.submitForm,type:"primary",class:"btn"},{default:d((()=>[_("提交")])),_:1},8,["onClick"]),p(P,{onClick:l.goBack,class:"btn"},{default:d((()=>[_("返回")])),_:1},8,["onClick"])])),_:1})])),_:1},8,["model","rules"]),p(E,{ref:"metricSelector",type:"dialog"},{default:d((()=>[p(U,{title:"选择指标",mode:"base","before-close":!0,onClose:l.closeMetricSelector,onConfirm:l.confirmSelectMetrics},{default:d((()=>[p(L,{class:"metric-selector"},{default:d((()=>[p(F,{onChange:l.onMetricSelect},{default:d((()=>[(f(!0),g(D,null,k(i.availableMetrics,(e=>(f(),n(B,{key:e.metricId,class:"metric-option"},{default:d((()=>[p(z,{value:e.metricId,checked:l.isMetricSelected(e.metricId)},null,8,["value","checked"]),p(j,{class:"metric-label"},{default:d((()=>[_(h(e.metricname),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1},8,["onChange"])])),_:1})])),_:1},8,["onClose","onConfirm"])])),_:1},512)])),_:1})}],["__scopeId","data-v-d16e4089"]]);export{L as default};
