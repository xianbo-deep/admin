import{_ as e,e as t,s as a,N as s,q as i,H as l,O as n,r,a as c,c as o,w as d,i as u,a5 as m,o as g,h as f,k as h,t as p,l as _,m as I,F as b,M as k,v as D,p as y,Z as M,Y as v,X as C,T as w}from"./index-1tsbwzWw.js";import{_ as A}from"./uni-easyinput.B-y-wvYA.js";import{_ as S}from"./uni-forms-item.C04_D_PQ.js";import{_ as x}from"./uni-forms.Cx-ojO0j.js";import{_ as O}from"./uni-popup-dialog.EWgTrJQg.js";const q=t.database(),L=[{value:"active",label:"启用"},{value:"inactive",label:"禁用"}];const V=e({data:()=>({formDataId:"",formData:{package_id:"",package_name:"",AgentId:"",status:"active",metrics:[]},statusIndex:0,agentIndex:0,statusOptions:L,agentOptions:[],availableMetrics:[],selectedMetricIds:[],rules:{package_id:{rules:[{required:!0,errorMessage:"请输入套餐ID"}]},package_name:{rules:[{required:!0,errorMessage:"请输入套餐名称"}]},AgentId:{rules:[{required:!0,errorMessage:"请选择Agent"}]},status:{rules:[{required:!0,errorMessage:"请选择套餐状态"}]}}}),async onLoad(e){await this.getAgentList(),e.id&&(this.formDataId=e.id,await this.getDetail(e.id)),await this.getMetricsList()},methods:{async getAgentList(){try{const e=await q.collection("Agent").where('status == "normal"').field("agentId,identifier").get();e.result&&e.result.data&&(this.agentOptions=e.result.data)}catch(e){a({content:"获取Agent列表失败："+e.message,showCancel:!1})}},getAgentLabel(){if(!this.formData.AgentId||!this.agentOptions.length)return"请选择Agent";const e=this.agentOptions.find((e=>e.agentId===this.formData.AgentId));return e?e.identifier:"请选择Agent"},onAgentChange(e){const t=e.detail.value;this.agentIndex=t,this.formData.AgentId=this.agentOptions[t].agentId},getStatusLabel(e){const t=L.find((t=>t.value===e));return t?t.label:"请选择状态"},onStatusChange(e){const t=e.detail.value;this.statusIndex=t,this.formData.status=L[t].value},async getMetricsList(){try{const e=await q.collection("Metric").field("metricId,metricname").get();e.result&&e.result.data&&(this.availableMetrics=e.result.data)}catch(e){a({content:"获取指标列表失败："+e.message,showCancel:!1})}},showMetricSelector(){this.selectedMetricIds=this.formData.metrics.map((e=>e.metric_id)),this.$refs.metricSelector.open()},closeMetricSelector(){this.$refs.metricSelector.close()},onMetricSelect(e){this.selectedMetricIds=e.detail.value},isMetricSelected(e){return this.selectedMetricIds.includes(e)},confirmSelectMetrics(){const e=this.availableMetrics.filter((e=>this.selectedMetricIds.includes(e.metricId))).map((e=>({metric_id:e.metricId,metric_name:e.metricname})));this.formData.metrics=e,this.closeMetricSelector()},removeMetric(e){a({title:"提示",content:"确定要移除该指标吗？",success:t=>{t.confirm&&this.formData.metrics.splice(e,1)}})},submitForm(){this.$refs.form.submit()},async submit(e){const{value:t,errors:r}=e.detail;if(!r){s({title:this.formDataId?"修改中...":"新增中...",mask:!0}),t.package_id=parseInt(t.package_id);try{if(!this.formDataId){if((await q.collection("Package").where("package_id == $1",[t.package_id]).get()).result.data.length>0)throw new Error("套餐ID已存在")}await this.submitData(t),i({title:this.formDataId?"修改成功":"新增成功"}),this.getOpenerEventChannel().emit("refreshData"),setTimeout((()=>l()),500)}catch(c){a({content:c.message||"提交失败",showCancel:!1})}finally{n()}}},async submitData(e){this.formDataId?await q.collection("Package").doc(this.formDataId).update(e):await q.collection("Package").add(e)},async getDetail(e){s({mask:!0});try{const t=(await q.collection("Package").doc(e).field("package_id,package_name,AgentId,status,metrics").get()).result.data[0];t&&(this.formData=Object.assign({},this.formData,t),this.statusIndex=L.findIndex((e=>e.value===t.status)),this.agentIndex=this.agentOptions.findIndex((e=>e.agentId===t.AgentId)))}catch(t){a({content:t.message||"获取详情失败",showCancel:!1})}finally{n()}}}},[["render",function(e,t,a,s,i,l){const n=r(c("uni-easyinput"),A),q=r(c("uni-forms-item"),S),L=u,V=k,j=D,P=y,$=M,z=r(c("uni-forms"),x),F=C,T=w,U=v,B=r(c("uni-popup-dialog"),O),E=r(c("uni-popup"),m);return g(),o(L,{class:"uni-container"},{default:d((()=>[f(z,{ref:"form",modelValue:i.formData,"onUpdate:modelValue":t[2]||(t[2]=e=>i.formData=e),rules:i.rules,validateTrigger:"bind",onSubmit:l.submit},{default:d((()=>[f(q,{name:"package_id",label:"套餐ID",required:""},{default:d((()=>[f(n,{modelValue:i.formData.package_id,"onUpdate:modelValue":t[0]||(t[0]=e=>i.formData.package_id=e),type:"number",clearable:!1,placeholder:"请输入套餐ID",disabled:!!i.formDataId},null,8,["modelValue","disabled"])])),_:1}),f(q,{name:"package_name",label:"套餐名称",required:""},{default:d((()=>[f(n,{modelValue:i.formData.package_name,"onUpdate:modelValue":t[1]||(t[1]=e=>i.formData.package_name=e),clearable:!1,placeholder:"请输入套餐名称"},null,8,["modelValue"])])),_:1}),f(q,{name:"AgentId",label:"Agent",required:""},{default:d((()=>[f(L,{class:"select-box"},{default:d((()=>[f(V,{onChange:l.onAgentChange,value:i.agentIndex,range:i.agentOptions,"range-key":"identifier"},{default:d((()=>[f(L,{class:"picker-item"},{default:d((()=>[h(p(l.getAgentLabel()),1)])),_:1})])),_:1},8,["onChange","value","range"])])),_:1})])),_:1}),f(q,{name:"status",label:"套餐状态",required:""},{default:d((()=>[f(L,{class:"select-box"},{default:d((()=>[f(V,{onChange:l.onStatusChange,value:i.statusIndex,range:i.statusOptions,"range-key":"label"},{default:d((()=>[f(L,{class:"picker-item"},{default:d((()=>[h(p(l.getStatusLabel(i.formData.status)),1)])),_:1})])),_:1},8,["onChange","value","range"])])),_:1})])),_:1}),f(L,{class:"metrics-section"},{default:d((()=>[f(L,{class:"section-header"},{default:d((()=>[f(j,{class:"section-title"},{default:d((()=>[h("指标列表")])),_:1}),f(P,{class:"uni-button",type:"primary",size:"mini",onClick:l.showMetricSelector},{default:d((()=>[h("添加指标")])),_:1},8,["onClick"])])),_:1}),i.formData.metrics.length?(g(),o(L,{key:0,class:"metrics-list"},{default:d((()=>[(g(!0),_(b,null,I(i.formData.metrics,((e,t)=>(g(),o(L,{key:e.metric_id,class:"metric-item"},{default:d((()=>[f(L,{class:"metric-info"},{default:d((()=>[f(j,{class:"metric-name"},{default:d((()=>[h(p(e.metric_name),1)])),_:2},1024),f(j,{class:"metric-id"},{default:d((()=>[h("("+p(e.metric_id)+")",1)])),_:2},1024)])),_:2},1024),f(P,{class:"uni-button",type:"warn",size:"mini",onClick:e=>l.removeMetric(t)},{default:d((()=>[h("移除")])),_:2},1032,["onClick"])])),_:2},1024)))),128))])),_:1})):(g(),o(L,{key:1,class:"empty-metrics"},{default:d((()=>[h(" 暂无指标，请添加 ")])),_:1}))])),_:1}),f(L,{class:"uni-button-group"},{default:d((()=>[f(P,{style:{width:"100px"},type:"primary",class:"uni-button",onClick:l.submitForm},{default:d((()=>[h("提交")])),_:1},8,["onClick"]),f($,{"open-type":"navigateBack",style:{"margin-left":"15px"}},{default:d((()=>[f(P,{style:{width:"100px"},class:"uni-button"},{default:d((()=>[h("返回")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue","rules","onSubmit"]),f(E,{ref:"metricSelector",type:"dialog"},{default:d((()=>[f(B,{title:"选择指标",mode:"base","before-close":!0,onClose:l.closeMetricSelector,onConfirm:l.confirmSelectMetrics},{default:d((()=>[f(L,{class:"metric-selector"},{default:d((()=>[f(U,{onChange:l.onMetricSelect},{default:d((()=>[(g(!0),_(b,null,I(i.availableMetrics,(e=>(g(),o(T,{key:e.metricId,class:"metric-option"},{default:d((()=>[f(F,{value:e.metricId,checked:l.isMetricSelected(e.metricId)},null,8,["value","checked"]),f(j,{class:"metric-label"},{default:d((()=>[h(p(e.metricname),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1},8,["onChange"])])),_:1})])),_:1},8,["onClose","onConfirm"])])),_:1},512)])),_:1})}],["__scopeId","data-v-d6e4e8d3"]]);export{V as default};
