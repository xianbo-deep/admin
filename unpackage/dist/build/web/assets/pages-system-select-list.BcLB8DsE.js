import{_ as e,e as a,s as t,q as n,r as s,a as i,c as l,w as r,i as o,b as d,d as c,f as u,g as h,o as g,h as m,k as p,l as f,m as b,F as _,I as y,p as I,t as C}from"./index-1tsbwzWw.js";import{_ as k}from"./uni-stat-breadcrumb.gfsZYonB.js";import{_ as w}from"./uni-pagination.DVZKLAsf.js";import{_ as x}from"./unicloud-db.DwiPvpWe.js";const S=a.database(),D=S.command;S.command.aggregate;const z=["selectId","fileId","packageName"],$={ascending:"asc",descending:"desc"};const T=e({data:()=>({query:"",where:"",orderby:"timestamp desc",orderByFieldName:"",selectedIndexs:[],options:{pageSize:20,pageCurrent:1,getone:!1,manual:!1},loading:!1,error:{message:""},data:[],userMap:new Map}),computed:{displayData(){return this.data.map((e=>({...e,nickname:this.userMap.get(e.userId)||"未知用户"})))}},mounted(){this.loadData()},methods:{formatTime(e){if(!e)return"-";const a=new Date(e);return isNaN(a.getTime())?"-":a.toLocaleString()},async fetchUserNicknames(e){if(e.length)try{const{result:a}=await S.collection("User").where({userId:D.in([...new Set(e)])}).field("userId,nickname").get();a&&a.data&&(this.userMap=new Map(a.data.map((e=>[e.userId,e.nickname]))))}catch(a){console.error("获取用户昵称失败:",a)}},getWhere(){const e=this.query.trim();if(!e)return"";const a=new RegExp(e,"i");return D.or(z.map((e=>({[e]:a}))))},search(){const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},changeSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb&&this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs=[],this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},sortChange(e,a){this.orderByFieldName=a,e.order?this.orderby=a+" "+$[e.order]:this.orderby="timestamp desc",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},async onqueryload(e){const a=Array.isArray(e)?e:e.data;if(!a||0===a.length)return void this.$set(this,"data",[]);const t=a.map((e=>e.userId)).filter(Boolean);await this.fetchUserNicknames(t),this.$set(this,"data",a)},selectedItems(){return this.data&&this.selectedIndexs?this.selectedIndexs.map((e=>this.data[e]._id)).filter(Boolean):[]},async delTable(){const e=this.selectedItems();if(e.length)try{t({title:"提示",content:"是否确认删除选中的记录？",success:async a=>{var t;a.confirm&&(await S.collection("Select").where({_id:D.in(e)}).remove(),this.selectedIndexs=[],null==(t=this.$refs.table)||t.clearSelection(),this.loadData(!0),n({title:"删除成功",icon:"success"}))}})}catch(a){console.error("删除失败:",a),n({title:"删除失败",icon:"error"})}},selectionChange(e){e&&e.detail&&Array.isArray(e.detail.index)&&(this.selectedIndexs=e.detail.index)},async confirmDelete(e){if(e)try{t({title:"提示",content:"是否确认删除该记录？",success:async a=>{a.confirm&&(await S.collection("Select").doc(e).remove(),this.loadData(!0),n({title:"删除成功",icon:"success"}))}})}catch(a){console.error("删除失败:",a),n({title:"删除失败",icon:"error"})}}}},[["render",function(e,a,t,n,S,D){const z=s(i("uni-stat-breadcrumb"),k),$=y,T=I,N=o,q=s(i("uni-th"),d),V=s(i("uni-tr"),c),U=s(i("uni-td"),u),v=s(i("uni-table"),h),M=s(i("uni-pagination"),w),j=s(i("unicloud-db"),x);return g(),l(N,{class:"fix-top-window"},{default:r((()=>[m(N,{class:"uni-header"},{default:r((()=>[m(z,{class:"uni-stat-breadcrumb-on-phone"}),m(N,{class:"uni-group"},{default:r((()=>[m($,{class:"uni-search",type:"text",modelValue:S.query,"onUpdate:modelValue":a[0]||(a[0]=e=>S.query=e),onConfirm:D.search,placeholder:"搜索选择..."},null,8,["modelValue","onConfirm"]),m(T,{class:"uni-button hide-on-phone",type:"default",size:"mini",onClick:D.search},{default:r((()=>[p("搜索")])),_:1},8,["onClick"]),m(T,{class:"uni-button",type:"warn",size:"mini",disabled:!S.selectedIndexs.length,onClick:D.delTable},{default:r((()=>[p("批量删除")])),_:1},8,["disabled","onClick"])])),_:1})])),_:1}),m(N,{class:"uni-container"},{default:r((()=>[m(j,{ref:"udb",collection:"Select",field:"selectId,fileId,userId,packageName,packageId,timestamp",where:S.where,"page-data":"replace",getcount:!0,"page-size":S.options.pageSize,"page-current":S.options.pageCurrent,orderby:S.orderby,loadtime:"manual",onLoad:D.onqueryload},{default:r((({pagination:e,loading:t,error:n})=>[m(v,{ref:"table",loading:t,emptyText:n.message||"没有数据",border:"",stripe:"",type:"selection",onSelectionChange:D.selectionChange},{default:r((()=>[m(V,null,{default:r((()=>[m(q,{align:"center",sortable:"",onSortChange:a[1]||(a[1]=e=>D.sortChange(e,"selectId"))},{default:r((()=>[p("选择ID")])),_:1}),m(q,{align:"center"},{default:r((()=>[p("用户昵称")])),_:1}),m(q,{align:"center",sortable:"",onSortChange:a[2]||(a[2]=e=>D.sortChange(e,"fileId"))},{default:r((()=>[p("文件ID")])),_:1}),m(q,{align:"center"},{default:r((()=>[p("套餐名称")])),_:1}),m(q,{align:"center"},{default:r((()=>[p("套餐ID")])),_:1}),m(q,{align:"center",sortable:"",onSortChange:a[3]||(a[3]=e=>D.sortChange(e,"timestamp"))},{default:r((()=>[p("提交时间")])),_:1}),m(q,{align:"center"},{default:r((()=>[p("操作")])),_:1})])),_:1}),(g(!0),f(_,null,b(D.displayData,((e,a)=>(g(),l(V,{key:e._id},{default:r((()=>[m(U,{align:"center"},{default:r((()=>[p(C(e.selectId),1)])),_:2},1024),m(U,{align:"center"},{default:r((()=>[m(N,{class:"ellipsis",title:e.nickname},{default:r((()=>[p(C(e.nickname),1)])),_:2},1032,["title"])])),_:2},1024),m(U,{align:"center"},{default:r((()=>[m(N,{class:"ellipsis",title:e.fileId},{default:r((()=>[p(C(e.fileId||"-"),1)])),_:2},1032,["title"])])),_:2},1024),m(U,{align:"center"},{default:r((()=>[p(C(e.packageName),1)])),_:2},1024),m(U,{align:"center"},{default:r((()=>[p(C(e.packageId||"-"),1)])),_:2},1024),m(U,{align:"center"},{default:r((()=>[p(C(D.formatTime(e.timestamp)),1)])),_:2},1024),m(U,{align:"center"},{default:r((()=>[m(N,{class:"uni-group"},{default:r((()=>[m(T,{onClick:a=>D.confirmDelete(e._id),class:"uni-button",size:"mini",type:"warn"},{default:r((()=>[p("删除")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1032,["loading","emptyText","onSelectionChange"]),m(N,{class:"uni-pagination-box"},{default:r((()=>[m(M,{"show-icon":"","show-page-size":"","page-size":e.size,modelValue:e.current,"onUpdate:modelValue":a=>e.current=a,total:e.count,onChange:D.onPageChanged,onPageSizeChange:D.changeSize},null,8,["page-size","modelValue","onUpdate:modelValue","total","onChange","onPageSizeChange"])])),_:2},1024)])),_:1},8,["where","page-size","page-current","orderby","onLoad"])])),_:1})])),_:1})}],["__scopeId","data-v-930b1adf"]]);export{T as default};
