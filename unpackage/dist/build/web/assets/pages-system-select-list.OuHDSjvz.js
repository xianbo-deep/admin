import{_ as e,e as t,s as a,q as i,r as n,a as s,c as l,w as o,i as r,b as d,d as c,f as u,g as h,a5 as m,o as p,h as f,k as g,l as _,m as y,F as b,I,p as C,S as w,t as k,j as x}from"./index-BQ2OFzYe.js";import{_ as D}from"./uni-stat-breadcrumb.DHkfubMW.js";import{_ as S}from"./uni-pagination.Bz9-uLqg.js";import{_ as z}from"./unicloud-db.C6t2K4BA.js";import{_ as $}from"./uni-popup-dialog.Dd--rJwc.js";const T=t.database(),v=T.command;T.command.aggregate;const P=["selectId","fileId"],j={ascending:"asc",descending:"desc"};const q=e({data:()=>({query:"",where:"",orderby:"timestamp desc",orderByFieldName:"",selectedIndexs:[],options:{pageSize:20,pageCurrent:1,getone:!1,manual:!1},loading:!1,error:{message:""},data:[],userMap:new Map,currentIndicators:[]}),computed:{displayData(){return this.data.map((e=>({...e,nickname:this.userMap.get(e.userId)||"未知用户"})))}},mounted(){this.loadData()},methods:{formatTime(e){if(!e)return"-";const t=new Date(e);return isNaN(t.getTime())?"-":t.toLocaleString()},formatIndicators:e=>e&&e.length?e.map((e=>e.name)).join(", "):"-",async fetchUserNicknames(e){if(e.length)try{const{result:t}=await T.collection("User").where({userId:v.in([...new Set(e)])}).field("userId,nickname").get();t&&t.data&&(this.userMap=new Map(t.data.map((e=>[e.userId,e.nickname]))))}catch(t){console.error("获取用户昵称失败:",t)}},getWhere(){const e=this.query.trim();if(!e)return"";const t=new RegExp(e,"i");return T.command.or(P.map((e=>({[e]:t}))))},search(){const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},changeSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb&&this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs=[],this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},sortChange(e,t){this.orderByFieldName=t,e.order?this.orderby=t+" "+j[e.order]:this.orderby="timestamp desc",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},async onqueryload(e){const t=Array.isArray(e)?e:e.data;if(!t||0===t.length)return void this.$set(this,"data",[]);const a=t.map((e=>e.userId)).filter(Boolean);await this.fetchUserNicknames(a),this.$set(this,"data",t)},viewDetails(e){this.currentIndicators=e.indicators,this.$refs.detailPopup.open()},closeDetails(){this.$refs.detailPopup.close(),this.currentIndicators=[]},handleConfirm(){this.$refs.detailPopup.close(),this.currentIndicators=[]},selectedItems(){return this.data&&this.selectedIndexs?this.selectedIndexs.map((e=>this.data[e]._id)).filter(Boolean):[]},async delTable(){const e=this.selectedItems();if(e.length)try{a({title:"提示",content:"是否确认删除选中的记录？",success:async t=>{var a;t.confirm&&(await T.collection("Select").where({_id:v.in(e)}).remove(),this.selectedIndexs=[],null==(a=this.$refs.table)||a.clearSelection(),this.loadData(!0),i({title:"删除成功",icon:"success"}))}})}catch(t){console.error("删除失败:",t),i({title:"删除失败",icon:"error"})}},selectionChange(e){e&&e.detail&&Array.isArray(e.detail.index)&&(this.selectedIndexs=e.detail.index)},async confirmDelete(e){if(e)try{a({title:"提示",content:"是否确认删除该记录？",success:async t=>{t.confirm&&(await T.collection("Select").doc(e).remove(),this.loadData(!0),i({title:"删除成功",icon:"success"}))}})}catch(t){console.error("删除失败:",t),i({title:"删除失败",icon:"error"})}}}},[["render",function(e,t,a,i,T,v){const P=n(s("uni-stat-breadcrumb"),D),j=I,q=C,V=r,N=n(s("uni-th"),d),U=n(s("uni-tr"),c),B=n(s("uni-td"),u),M=n(s("uni-table"),h),A=n(s("uni-pagination"),S),F=n(s("unicloud-db"),z),L=w,W=n(s("uni-popup-dialog"),$),E=n(s("uni-popup"),m);return p(),l(V,{class:"fix-top-window"},{default:o((()=>[f(V,{class:"uni-header"},{default:o((()=>[f(P,{class:"uni-stat-breadcrumb-on-phone"}),f(V,{class:"uni-group"},{default:o((()=>[f(j,{class:"uni-search",type:"text",modelValue:T.query,"onUpdate:modelValue":t[0]||(t[0]=e=>T.query=e),onConfirm:v.search,placeholder:"搜索选择..."},null,8,["modelValue","onConfirm"]),f(q,{class:"uni-button hide-on-phone",type:"default",size:"mini",onClick:v.search},{default:o((()=>[g("搜索")])),_:1},8,["onClick"]),f(q,{class:"uni-button",type:"warn",size:"mini",disabled:!T.selectedIndexs.length,onClick:v.delTable},{default:o((()=>[g("批量删除")])),_:1},8,["disabled","onClick"])])),_:1})])),_:1}),f(V,{class:"uni-container"},{default:o((()=>[f(F,{ref:"udb",collection:"Select",field:"selectId,fileId,userId,indicators,timestamp",where:T.where,"page-data":"replace",getcount:!0,"page-size":T.options.pageSize,"page-current":T.options.pageCurrent,orderby:T.orderby,loadtime:"manual",onLoad:v.onqueryload},{default:o((({pagination:e,loading:a,error:i})=>[f(M,{ref:"table",loading:a,emptyText:i.message||"没有数据",border:"",stripe:"",type:"selection",onSelectionChange:v.selectionChange},{default:o((()=>[f(U,null,{default:o((()=>[f(N,{align:"center",sortable:"",onSortChange:t[1]||(t[1]=e=>v.sortChange(e,"selectId"))},{default:o((()=>[g("选择ID")])),_:1}),f(N,{align:"center"},{default:o((()=>[g("用户昵称")])),_:1}),f(N,{align:"center",sortable:"",onSortChange:t[2]||(t[2]=e=>v.sortChange(e,"fileId"))},{default:o((()=>[g("文件ID")])),_:1}),f(N,{align:"center"},{default:o((()=>[g("指标数量")])),_:1}),f(N,{align:"center"},{default:o((()=>[g("指标列表")])),_:1}),f(N,{align:"center",sortable:"",onSortChange:t[3]||(t[3]=e=>v.sortChange(e,"timestamp"))},{default:o((()=>[g("提交时间")])),_:1}),f(N,{align:"center"},{default:o((()=>[g("操作")])),_:1})])),_:1}),(p(!0),_(b,null,y(v.displayData,((e,t)=>(p(),l(U,{key:e._id},{default:o((()=>[f(B,{align:"center"},{default:o((()=>[g(k(e.selectId),1)])),_:2},1024),f(B,{align:"center"},{default:o((()=>[f(V,{class:"ellipsis",title:e.nickname},{default:o((()=>[g(k(e.nickname),1)])),_:2},1032,["title"])])),_:2},1024),f(B,{align:"center"},{default:o((()=>[f(V,{class:"ellipsis",title:e.fileId},{default:o((()=>[g(k(e.fileId||"-"),1)])),_:2},1032,["title"])])),_:2},1024),f(B,{align:"center"},{default:o((()=>[g(k(e.indicators.length),1)])),_:2},1024),f(B,{align:"center"},{default:o((()=>[f(V,{class:"ellipsis",title:v.formatIndicators(e.indicators)},{default:o((()=>[g(k(v.formatIndicators(e.indicators)),1)])),_:2},1032,["title"])])),_:2},1024),f(B,{align:"center"},{default:o((()=>[g(k(v.formatTime(e.timestamp)),1)])),_:2},1024),f(B,{align:"center"},{default:o((()=>[f(V,{class:"uni-group"},{default:o((()=>[f(q,{onClick:t=>v.viewDetails(e),class:"uni-button",size:"mini",type:"primary"},{default:o((()=>[g("查看")])),_:2},1032,["onClick"]),f(q,{onClick:t=>v.confirmDelete(e._id),class:"uni-button",size:"mini",type:"warn"},{default:o((()=>[g("删除")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1032,["loading","emptyText","onSelectionChange"]),f(V,{class:"uni-pagination-box"},{default:o((()=>[f(A,{"show-icon":"","show-page-size":"","page-size":e.size,modelValue:e.current,"onUpdate:modelValue":t=>e.current=t,total:e.count,onChange:v.onPageChanged,onPageSizeChange:v.changeSize},null,8,["page-size","modelValue","onUpdate:modelValue","total","onChange","onPageSizeChange"])])),_:2},1024)])),_:1},8,["where","page-size","page-current","orderby","onLoad"])])),_:1}),f(E,{ref:"detailPopup",type:"dialog"},{default:o((()=>[f(W,{mode:"base",title:"指标详情","before-close":!0,onClose:v.closeDetails,onConfirm:v.handleConfirm,confirmText:"确定"},{default:o((()=>[f(L,{style:{"max-height":"60vh"},"scroll-y":""},{default:o((()=>[(p(!0),_(b,null,y(T.currentIndicators,((e,t)=>(p(),l(V,{key:t,class:"indicator-item"},{default:o((()=>[f(V,{class:"indicator-header"},{default:o((()=>[g(k(e.name)+" (ID: "+k(e.id)+") ",1)])),_:2},1024),e.description?(p(),l(V,{key:0,class:"indicator-description"},{default:o((()=>[g(k(e.description),1)])),_:2},1024)):x("",!0)])),_:2},1024)))),128))])),_:1})])),_:1},8,["onClose","onConfirm"])])),_:1},512)])),_:1})}],["__scopeId","data-v-94e4a45f"]]);export{q as default};
