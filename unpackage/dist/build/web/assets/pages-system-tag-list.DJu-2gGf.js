import{e,_ as t,s as a,az as s,r as l,a as n,B as i,a5 as o,o as r,c as d,w as u,h as m,k as c,t as p,j as h,l as f,F as g,L as _,m as y,i as C,X as b,Y as v,v as x,p as k,n as D,b as T,d as w,f as S,g as M,I as $}from"./index-1tsbwzWw.js";import{_ as z}from"./uni-stat-breadcrumb.gfsZYonB.js";import{_ as P}from"./download-excel.CKAJ50gX.js";import{_ as V}from"./uni-tag.DJHF5HP_.js";import{_ as I}from"./uni-dateformat.C6gbRjd6.js";import{_ as j}from"./uni-pagination.DVZKLAsf.js";import{_ as F}from"./unicloud-db.DwiPvpWe.js";import{_ as U}from"./uni-data-select.ZmgLG0mc.js";import{_ as E}from"./uni-forms-item.C04_D_PQ.js";import{_ as L}from"./uni-easyinput.B-y-wvYA.js";import{_ as q}from"./uni-forms.Cx-ojO0j.js";import{e as R,f as O}from"./uni-id-tag.B4DgDmWM.js";const A=e.importObject("uni-sms-co");const B=t({name:"batchSms",props:{toType:String,receiver:{type:Array,default:()=>[]},condition:{type:Object,default:()=>({})}},data:()=>({smsTemplateLoading:!1,smsPresetList:[{value:"all",text:"全部用户"},{value:"7-day-offline-users",text:"7天内未登录用户"},{value:"15-day-offline-users",text:"15天内未登录用户"},{value:"30-day-offline-users",text:"30天内未登录用户"}],smsTemplate:[],smsTemplateDataErrorMessage:"",smsDataModel:{name:"",templateId:"",templateData:[],smsPreset:"",filtered:!1},smsTemplateContent:"",smsPreviewContent:[],smsSendUserCount:0}),computed:{isSelectedReceiver(){return!!this.receiver.length},sendAll(){return"all"===this.smsDataModel.smsPreset||"userTags"===this.toType},hasCondition(){return!!Object.keys(this.condition).length}},watch:{smsDataModel:{handler(e){if(!e.templateId)return"";const t=this.smsTemplate.find((t=>t.value===e.templateId));let a=e.templateData.reduce(((e,t)=>{const a=new RegExp(`\\$\\{${t.field}\\}`);return e.replace(a,(e=>t.value||e))}),t.content);this.smsTemplateContent=`【${t.sign}】${a}`},deep:!0}},methods:{smsFilteredChange(){this.smsDataModel.filtered=!this.smsDataModel.filtered},popupChange(e){e.show||this.reset()},open(){this.$refs.smsPopup.open(),this.loadSmsTemplate()},close(){this.reset(),this.$refs.smsPopup.close()},async loadSmsTemplate(){if(!(this.smsTemplate.length>0||this.smsTemplateLoading)){this.smsTemplateLoading=!0;try{const t=e.importObject("uni-sms-co",{customUI:!0}),a=await t.template();this.smsTemplate=a.map((e=>({...e,value:e._id,text:e.name})))}finally{this.smsTemplateLoading=!1}}},onSmsTemplateSelected(e){const t=this.smsTemplate.find((t=>t.value===e));if(!t)return;const a=new RegExp(/\$\{(.*?)\}/g);let s,l=[];for(;s=a.exec(t.content);){const e=s[1];e&&l.push({field:e,value:""})}this.smsDataModel.templateData=l},async sendSms(e=!1){const t=await this.$refs.smsForm.validate(),s=this.receiver;for(const a of this.smsDataModel.templateData)if(!a.value)return void(this.smsTemplateDataErrorMessage="字段/值不可为空");this.smsTemplateDataErrorMessage="";const l={type:this.toType,receiver:s};if((this.smsDataModel.filtered||this.smsDataModel.smsPreset)&&(l.condition=this.smsDataModel.smsPreset||this.condition),e){const e=await A.preview(l,t.templateId,this.smsDataModel.templateData);if(0===e.errCode)return this.smsPreviewContent=e.list,this.$refs.previewPopup.open(),void(this.smsSendUserCount=e.total)}a({title:"发送确认",content:`短信${this.sendAll?"将发送给所有用户":this.smsSendUserCount?`预计发送${this.smsSendUserCount}人`:"将发送给符合条件的用户"}，确定发送？`,success:async e=>{if(this.smsSendUserCount=0,e.cancel)return;(await A.createSmsTask(l,t.templateId,this.smsDataModel.templateData,{taskName:t.name})).taskId&&a({content:"短信任务已提交，您可在DCloud开发者后台查看短信发送记录",confirmText:"立即查看",cancelText:"关闭",success:e=>{e.cancel?(this.reset(),this.$refs.smsPopup.close()):(window.open("https://dev.dcloud.net.cn/#/pages/sms/sendLog","_blank"),this.reset(),this.$refs.smsPopup.close())}})}})},chooseFile(){void 0!==window.FileReader?s({count:1,extension:[".json"],success:({tempFiles:e})=>{if(e.length<=0)return;const[t]=e,a=new FileReader;a.readAsText(t),a.onload=()=>this.parserFileJson(null,a.result),a.onerror=()=>this.parserFileJson(a.error)},fail:()=>{a({content:"打开选择文件框失败",showCancel:!1})}}):a({content:"当前浏览器不支持文件上传，请升级浏览器重试",showCancel:!1})},async parserFileJson(e,t){if(e)return console.error(e),void a({content:"文件读取失败，请重新上传文件",showCancel:!1});let s=[];try{s=JSON.parse(t)}catch(l){return console.error(l),void a({content:"短信模板解析失败，请检查模板格式",showCancel:!1})}0===(await A.updateTemplates(s)).errCode&&a({content:"短信模板更新成功",showCancel:!1,success:()=>{this.loadSmsTemplate()}})},reset(){this.smsDataModel.name="",this.smsDataModel.smsPreset="",this.smsDataModel.templateId="",this.smsDataModel.templateData=[],this.smsPreviewContent=[],this.smsTemplateContent="",this.smsSendUserCount=0}}},[["render",function(e,t,a,s,D,T){const w=C,S=l(n("uni-data-select"),U),M=l(n("uni-forms-item"),E),$=b,z=v,P=l(n("uni-easyinput"),L),V=x,I=k,j=l(n("uni-forms"),q),F=l(n("uni-icons"),i),R=l(n("uni-popup"),o);return r(),d(w,null,{default:u((()=>[m(R,{ref:"smsPopup",type:"center",onChange:T.popupChange,"is-mask-click":!1},{default:u((()=>[m(w,{class:"sms-manager"},{default:u((()=>[m(w,{class:"sms-manager--header mb"},{default:u((()=>[c("群发短信")])),_:1}),m(j,{"label-width":100,modelValue:D.smsDataModel,ref:"smsForm"},{default:u((()=>["user"!==a.toType||T.isSelectedReceiver?"user"===a.toType&&T.isSelectedReceiver?(r(),d(M,{key:1,label:"目标对象"},{default:u((()=>[m(w,null,{default:u((()=>[c("当前已选择"+p(a.receiver.length)+"人",1)])),_:1})])),_:1})):"userTags"===a.toType?(r(),d(M,{key:2,label:"目标对象"},{default:u((()=>[m(w,null,{default:u((()=>[c("当前已选择"+p(a.receiver.length)+"个标签",1)])),_:1}),m(w,{class:"sms-data-tip"},{default:u((()=>[c("如标签关联的用户没有绑定手机号，将不会发送短信。")])),_:1})])),_:1})):h("",!0):(r(),d(M,{key:0,label:"目标对象",name:"smsPreset",rules:[{required:!0,errorMessage:"请选择目标对象"}],required:""},{default:u((()=>[m(S,{class:"type m",placeholder:"预设条件",size:"mini",clear:!1,localdata:D.smsPresetList,modelValue:D.smsDataModel.smsPreset,"onUpdate:modelValue":t[0]||(t[0]=e=>D.smsDataModel.smsPreset=e)},null,8,["localdata","modelValue"]),m(w,{class:"sms-data-tip"},{default:u((()=>[c("如需给指定用户发送，请在列表选择要发送的用户。")])),_:1})])),_:1})),T.isSelectedReceiver&&T.hasCondition?(r(),d(M,{key:3,label:"跨分页选择"},{default:u((()=>[m(z,{onChange:T.smsFilteredChange},{default:u((()=>[m($,{style:{transform:"scale(.9)"},checked:D.smsDataModel.filtered},null,8,["checked"])])),_:1},8,["onChange"]),m(w,{class:"sms-data-tip"},{default:u((()=>[c("对用户进行了筛选后，可能存在分页无法全部选中时，请勾选跨分页选中")])),_:1})])),_:1})):h("",!0),m(M,{label:"任务名称",name:"name",required:"",rules:[{required:!0,errorMessage:"请输入任务名称"}]},{default:u((()=>[m(P,{modelValue:D.smsDataModel.name,"onUpdate:modelValue":t[1]||(t[1]=e=>D.smsDataModel.name=e),placeholder:"请输入任务名称，例如 “7日内未登录用户召回”"},null,8,["modelValue"])])),_:1}),m(M,{required:"",label:"短信模板",name:"templateId",rules:[{required:!0,errorMessage:"请选择短信模板"}]},{default:u((()=>[D.smsTemplateLoading?(r(),f(g,{key:1},[c(" 模板加载中... ")],64)):(r(),f(g,{key:0},[D.smsTemplate.length?(r(),d(w,{key:0},{default:u((()=>[m(S,{class:"type m",placeholder:"请选择短信模板",size:"mini",clear:!1,localdata:D.smsTemplate,modelValue:D.smsDataModel.templateId,"onUpdate:modelValue":t[2]||(t[2]=e=>D.smsDataModel.templateId=e),onChange:T.onSmsTemplateSelected},null,8,["localdata","modelValue","onChange"]),m(w,{class:"sms-data-tip"},{default:u((()=>[c(" 导入短信模版参考"),_("a",{class:"a-link",href:"https://uniapp.dcloud.net.cn/uniCloud/admin.html#群发短信",target:"_blank"},"教程"),c("；若有新的短信模版，可 "),m(V,{onClick:T.chooseFile,class:"a-link"},{default:u((()=>[c("点此导入 ")])),_:1},8,["onClick"])])),_:1})])),_:1})):(r(),d(w,{key:1},{default:u((()=>[m(I,{onClick:T.chooseFile,type:"primary",style:{width:"120px"},size:"mini"},{default:u((()=>[c("上传短信模板 ")])),_:1},8,["onClick"]),m(w,{class:"sms-data-tip"},{default:u((()=>[c("当前未导入短信模板，请从dev.dcloud.net.cn的短信-"),_("a",{href:"https://dev.dcloud.net.cn/pages/sms/template",target:"_blank"},"模板配置"),c("中导出短信模版，并在此导入。教程"),_("a",{href:"https://uniapp.dcloud.net.cn/uniCloud/admin.html#batch-sms",target:"_blank"},"详见")])),_:1})])),_:1}))],64))])),_:1}),D.smsTemplateContent?(r(),d(M,{key:4,label:"短信内容"},{default:u((()=>[m(w,{class:"form-item-flex-center"},{default:u((()=>[c(p(D.smsTemplateContent),1)])),_:1})])),_:1})):h("",!0),D.smsDataModel.templateData.length?(r(),d(M,{key:5,label:"模板变量配置","error-message":D.smsTemplateDataErrorMessage},{default:u((()=>[(r(!0),f(g,null,y(D.smsDataModel.templateData,((e,t)=>(r(),d(w,{class:"sms-data-item",key:e.field},{default:u((()=>[m(P,{class:"field m",modelValue:e.field,"onUpdate:modelValue":t=>e.field=t,placeholder:"字段",clearable:!1,disabled:!0,style:{width:"120px",flex:"none"}},null,8,["modelValue","onUpdate:modelValue"]),m(P,{class:"value m",modelValue:e.value,"onUpdate:modelValue":t=>e.value=t,placeholder:"例 {uni-id-users.username}",clearable:!1},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024)))),128)),m(w,{class:"sms-data-tip"},{default:u((()=>[c(" 短信变量支持固定值和数据表查询两种方式；固定值如：各位同事，数据表查询如：{uni-id-users.username}；请注意，若使用数据表查询方式，目前仅支持查询 uni-id-users 表；并注意确保数据库中查询字段值不为空，否则短信将发送失败。 ")])),_:1})])),_:1},8,["error-message"])):h("",!0)])),_:1},8,["modelValue"]),m(w,{class:"uni-group"},{default:u((()=>[m(I,{onClick:t[3]||(t[3]=e=>T.sendSms(!0)),class:"uni-button"},{default:u((()=>[c("预览")])),_:1}),m(I,{onClick:t[4]||(t[4]=e=>T.sendSms()),class:"uni-button",type:"primary"},{default:u((()=>[c("提交")])),_:1})])),_:1})])),_:1}),m(F,{type:"closeempty",size:"24",class:"close",onClick:T.close},null,8,["onClick"])])),_:1},8,["onChange"]),m(R,{ref:"previewPopup",type:"center","is-mask-click":!1},{default:u((()=>[m(w,{class:"sms-manager preview"},{default:u((()=>[m(w,{class:"sms-manager--header mb"},{default:u((()=>[m(w,null,{default:u((()=>[c("短信预览")])),_:1}),m(w,{class:"sub-title"},{default:u((()=>[c("仅预览第一条短信内容")])),_:1}),m(w,{class:"sub-title"},{default:u((()=>[c("预计送达 "),m(V,{style:{color:"red"}},{default:u((()=>[c(p(D.smsSendUserCount),1)])),_:1}),c(" 位用户")])),_:1})])),_:1}),m(w,{class:"content"},{default:u((()=>[(r(!0),f(g,null,y(D.smsPreviewContent,((e,t)=>(r(),d(w,{key:t},{default:u((()=>[c(p(e),1)])),_:2},1024)))),128)),m(w,{class:"length"},{default:u((()=>[c("短信字数： "),m(V,{class:"num"},{default:u((()=>[c(p(D.smsPreviewContent.length?D.smsPreviewContent[0].length:0),1)])),_:1}),c(" 字 ")])),_:1})])),_:1}),m(w,{class:"tip"},{default:u((()=>[m(w,null,{default:u((()=>[c("说明：")])),_:1}),m(w,null,{default:u((()=>[c("若从数据表中查询，字段内容长度会影响总字数，短信字数＝短信签名字数+短信内容字数。")])),_:1}),m(w,null,{default:u((()=>[c("短信长度不超过70个字，按照一条短信计费；超过70个字，按照67字/条拆分成多条计费。")])),_:1})])),_:1}),m(w,{class:"uni-group"},{default:u((()=>[m(I,{onClick:t[5]||(t[5]=t=>e.$refs.previewPopup.close()),class:"uni-button"},{default:u((()=>[c("关闭")])),_:1})])),_:1})])),_:1})])),_:1},512)])),_:1})}],["__scopeId","data-v-8d95bc59"]]),J=e.database(),N=[],W={ascending:"asc",descending:"desc"};const X=t({data:()=>({query:"",where:"",orderby:"",orderByFieldName:"",selectedIndexs:[],options:{pageSize:20,pageCurrent:1,filterData:{},...R},imageStyles:{width:64,height:64},exportExcel:{filename:"uni-id-tag.xls",type:"xls",fields:{"标签的tagid":"tagid","标签名称":"name","标签描述":"description"}},exportExcelData:[]}),onLoad(){this._filter={}},onReady(){this.$refs.udb.loadData()},computed:{smsReceiver(){if(this.selectedIndexs.length){let e=this.$refs.udb.dataList;return this.selectedIndexs.map((t=>e[t].tagid))}}},methods:{onqueryload(e){this.exportExcelData=e},changeSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.$nextTick((()=>{this.loadData()}))},getWhere(){const e=this.query.trim();if(!e)return"";const t=new RegExp(e,"i");return N.map((e=>t+".test("+e+")")).join(" || ")},search(){const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs.length=0,this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},navigateTo(e,t){D({url:e,events:{refreshData:()=>{this.loadData(t)}}})},selectedItems(){let e=this.$refs.udb.dataList;return this.selectedIndexs.map((t=>e[t]._id))},delTable(){this.$refs.udb.remove(this.selectedItems(),{success:e=>{this.$refs.table.clearSelection()}})},selectionChange(e){this.selectedIndexs=e.detail.index},confirmDelete(e){this.$refs.udb.remove(e,{success:e=>{this.$refs.table.clearSelection()}})},sortChange(e,t){this.orderByFieldName=t,e.order?this.orderby=t+" "+W[e.order]:this.orderby="",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},filterChange(e,t){this._filter[t]={type:e.filterType,value:e.filter};let a=O(this._filter,J.command);Object.keys(a).length?this.where=a:this.where="",this.$nextTick((()=>{this.$refs.udb.loadData()}))}}},[["render",function(e,t,a,s,i,o){const h=l(n("uni-stat-breadcrumb"),z),_=$,b=k,v=l(n("download-excel"),P),x=C,D=l(n("uni-th"),T),U=l(n("uni-tr"),w),E=l(n("uni-td"),S),L=l(n("uni-tag"),V),q=l(n("uni-dateformat"),I),R=l(n("uni-table"),M),O=l(n("uni-pagination"),j),A=l(n("unicloud-db"),F),J=l(n("batch-sms"),B);return r(),d(x,{class:"fix-top-window"},{default:u((()=>[m(x,{class:"uni-header"},{default:u((()=>[m(h,{class:"uni-stat-breadcrumb-on-phone"}),m(x,{class:"uni-group"},{default:u((()=>[m(_,{class:"uni-search",type:"text",modelValue:i.query,"onUpdate:modelValue":t[0]||(t[0]=e=>i.query=e),onConfirm:o.search,placeholder:"请输入搜索内容"},null,8,["modelValue","onConfirm"]),m(b,{class:"uni-button hide-on-phone",type:"default",size:"mini",onClick:o.search},{default:u((()=>[c("搜索")])),_:1},8,["onClick"]),m(b,{class:"uni-button",type:"primary",size:"mini",onClick:t[1]||(t[1]=e=>o.navigateTo("./add"))},{default:u((()=>[c("新增")])),_:1}),m(b,{class:"uni-button",type:"warn",size:"mini",disabled:!i.selectedIndexs.length,onClick:o.delTable},{default:u((()=>[c("批量删除")])),_:1},8,["disabled","onClick"]),m(v,{class:"hide-on-phone",fields:i.exportExcel.fields,data:i.exportExcelData,type:i.exportExcel.type,name:i.exportExcel.filename},{default:u((()=>[m(b,{class:"uni-button",type:"primary",size:"mini"},{default:u((()=>[c("导出 Excel")])),_:1})])),_:1},8,["fields","data","type","name"]),m(b,{class:"uni-button",type:"primary",size:"mini",onClick:t[2]||(t[2]=t=>e.$refs.batchSms.open())},{default:u((()=>[c("群发短信")])),_:1})])),_:1})])),_:1}),m(x,{class:"uni-container"},{default:u((()=>[m(A,{ref:"udb",collection:"uni-id-tag",field:"tagid,name,description,create_date",where:i.where,"page-data":"replace",orderby:i.orderby,getcount:!0,"page-size":i.options.pageSize,"page-current":i.options.pageCurrent,options:i.options,loadtime:"manual",onLoad:o.onqueryload},{default:u((({data:e,pagination:a,loading:s,error:l,options:n})=>[m(R,{ref:"table",loading:s,emptyText:l.message||"没有更多数据",border:"",stripe:"",type:"selection",onSelectionChange:o.selectionChange},{default:u((()=>[m(U,null,{default:u((()=>[m(D,{align:"center","filter-type":"search",onFilterChange:t[3]||(t[3]=e=>o.filterChange(e,"tagid")),sortable:"",onSortChange:t[4]||(t[4]=e=>o.sortChange(e,"tagid"))},{default:u((()=>[c("标签的tagid")])),_:1}),m(D,{align:"center","filter-type":"search",onFilterChange:t[5]||(t[5]=e=>o.filterChange(e,"name")),sortable:"",onSortChange:t[6]||(t[6]=e=>o.sortChange(e,"name"))},{default:u((()=>[c("标签名称")])),_:1}),m(D,{align:"center","filter-type":"search",onFilterChange:t[7]||(t[7]=e=>o.filterChange(e,"description")),sortable:"",onSortChange:t[8]||(t[8]=e=>o.sortChange(e,"description"))},{default:u((()=>[c("标签描述")])),_:1}),m(D,{align:"center","filter-type":"timestamp",onFilterChange:t[9]||(t[9]=e=>o.filterChange(e,"create_date")),sortable:"",onSortChange:t[10]||(t[10]=e=>o.sortChange(e,"create_date"))},{default:u((()=>[c("创建时间")])),_:1}),m(D,{align:"center"},{default:u((()=>[c("操作")])),_:1})])),_:1}),(r(!0),f(g,null,y(e,((e,t)=>(r(),d(U,{key:t},{default:u((()=>[m(E,{align:"center"},{default:u((()=>[c(p(e.tagid),1)])),_:2},1024),m(E,{align:"center"},{default:u((()=>[m(L,{type:"primary",inverted:"",size:"small",text:e.name},null,8,["text"])])),_:2},1024),m(E,{align:"center"},{default:u((()=>[c(p(e.description),1)])),_:2},1024),m(E,{align:"center"},{default:u((()=>[m(q,{threshold:[0,0],date:e.create_date},null,8,["date"])])),_:2},1024),m(E,{align:"center"},{default:u((()=>[m(x,{class:"uni-group"},{default:u((()=>[m(b,{onClick:t=>o.navigateTo("../user/list?tagid="+e.tagid,!1),class:"uni-button",size:"mini",type:"primary"},{default:u((()=>[c("成员")])),_:2},1032,["onClick"]),m(b,{onClick:t=>o.navigateTo("./edit?id="+e._id,!1),class:"uni-button",size:"mini",type:"primary"},{default:u((()=>[c("修改")])),_:2},1032,["onClick"]),m(b,{onClick:t=>o.confirmDelete(e._id),class:"uni-button",size:"mini",type:"warn"},{default:u((()=>[c("删除")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1032,["loading","emptyText","onSelectionChange"]),m(x,{class:"uni-pagination-box"},{default:u((()=>[m(O,{"show-iconn":"","show-page-size":"","page-size":a.size,modelValue:a.current,"onUpdate:modelValue":e=>a.current=e,total:a.count,onChange:o.onPageChanged,onPageSizeChange:o.changeSize},null,8,["page-size","modelValue","onUpdate:modelValue","total","onChange","onPageSizeChange"])])),_:2},1024)])),_:1},8,["where","orderby","page-size","page-current","options","onLoad"])])),_:1}),m(J,{ref:"batchSms",toType:"userTags",receiver:o.smsReceiver},null,8,["receiver"])])),_:1})}]]);export{X as default};
