import{_ as e,e as a,r as t,a as r,c as n,w as i,i as s,b as d,d as o,f as l,g as u,o as c,h as g,k as h,l as m,m as p,F as f,I as y,p as C,t as _}from"./index-1tsbwzWw.js";import{_ as b}from"./uni-stat-breadcrumb.gfsZYonB.js";import{_ as T}from"./uni-tag.DJHF5HP_.js";import{_ as w}from"./uni-pagination.DVZKLAsf.js";import{_ as I}from"./unicloud-db.DwiPvpWe.js";const x=a.database(),z=x.command,k={ascending:"asc",descending:"desc"},S={daily:"日卡",monthly:"月卡",times:"次卡"},$={daily:"primary",monthly:"success",times:"warning"};const V=e({data:()=>({query:"",where:"",orderby:"redeemTime desc",orderByFieldName:"",options:{pageSize:20,pageCurrent:1,getone:!1,manual:!1},data:[],userMap:new Map}),computed:{displayData(){return this.data.map((e=>({...e,nickname:this.userMap.get(e.userId)||"未知用户"})))}},mounted(){this.loadData()},methods:{formatTime(e){if(!e)return"-";const a=new Date(Number(e));return isNaN(a.getTime())?"-":a.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})},formatCardType:e=>S[e]||e,getCardTypeTag:e=>$[e]||"info",formatCardValue:(e,a)=>"times"===e?`${a}次`:`${a}天`,async getWhere(){const e=this.query.trim();if(!e)return"";try{const a=(await x.collection("User").where({nickname:new RegExp(e,"i")}).field("userId").get()).result.data.map((e=>e.userId));return z.or([{cardId:new RegExp(e,"i")},{userId:z.in(a)}])}catch(a){return console.error("搜索用户失败:",a),{cardId:new RegExp(e,"i")}}},async search(){this.options.pageCurrent=1;const e=await this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData(!0)}))},changeSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb&&this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.$refs.udb.loadData({current:e.current})},sortChange(e,a){this.orderByFieldName=a,e.order?this.orderby=a+" "+k[e.order]:this.orderby="redeemTime desc",this.$nextTick((()=>{this.$refs.udb.loadData()}))},async onqueryload(e){const a=Array.isArray(e)?e:e.data;if(!a||0===a.length)return void this.$set(this,"data",[]);const t=[...new Set(a.map((e=>e.userId)))];try{if(t.length>0){const e=await x.collection("User").where({userId:z.in(t)}).field("userId,nickname").get();this.userMap=new Map(e.result.data.map((e=>[e.userId,e.nickname])))}this.$set(this,"data",a)}catch(r){console.error("获取用户信息失败:",r),this.$set(this,"data",a)}}}},[["render",function(e,a,x,z,k,S){const $=t(r("uni-stat-breadcrumb"),b),V=y,D=C,q=s,N=t(r("uni-th"),d),j=t(r("uni-tr"),o),M=t(r("uni-td"),l),U=t(r("uni-tag"),T),E=t(r("uni-table"),u),L=t(r("uni-pagination"),w),P=t(r("unicloud-db"),I);return c(),n(q,{class:"fix-top-window"},{default:i((()=>[g(q,{class:"uni-header"},{default:i((()=>[g($,{class:"uni-stat-breadcrumb-on-phone"}),g(q,{class:"uni-group"},{default:i((()=>[g(V,{class:"uni-search",type:"text",modelValue:k.query,"onUpdate:modelValue":a[0]||(a[0]=e=>k.query=e),onConfirm:S.search,placeholder:"搜索卡号/用户ID..."},null,8,["modelValue","onConfirm"]),g(D,{class:"uni-button hide-on-phone",type:"default",size:"mini",onClick:S.search},{default:i((()=>[h("搜索")])),_:1},8,["onClick"])])),_:1})])),_:1}),g(q,{class:"uni-container"},{default:i((()=>[g(P,{ref:"udb",collection:"ExchangeRecord",field:"userId,cardId,cardCode,redeemTime,cardType,cardValue",where:k.where,"page-data":"replace",getcount:!0,"page-size":k.options.pageSize,"page-current":k.options.pageCurrent,orderby:k.orderby,loadtime:"manual",onLoad:S.onqueryload},{default:i((({pagination:e,loading:t,error:r})=>[g(E,{ref:"table",loading:t,emptyText:r.message||"没有数据",border:"",stripe:""},{default:i((()=>[g(j,null,{default:i((()=>[g(N,{align:"center",sortable:"",onSortChange:a[1]||(a[1]=e=>S.sortChange(e,"cardId"))},{default:i((()=>[h("卡号")])),_:1}),g(N,{align:"center"},{default:i((()=>[h("用户昵称")])),_:1}),g(N,{align:"center"},{default:i((()=>[h("卡密")])),_:1}),g(N,{align:"center",sortable:"",onSortChange:a[2]||(a[2]=e=>S.sortChange(e,"cardType"))},{default:i((()=>[h("卡密类型")])),_:1}),g(N,{align:"center",sortable:"",onSortChange:a[3]||(a[3]=e=>S.sortChange(e,"cardValue"))},{default:i((()=>[h("面值")])),_:1}),g(N,{align:"center",sortable:"",onSortChange:a[4]||(a[4]=e=>S.sortChange(e,"redeemTime"))},{default:i((()=>[h("兑换时间")])),_:1})])),_:1}),(c(!0),m(f,null,p(S.displayData,((e,a)=>(c(),n(j,{key:e._id},{default:i((()=>[g(M,{align:"center"},{default:i((()=>[g(q,{class:"ellipsis",title:e.cardId},{default:i((()=>[h(_(e.cardId),1)])),_:2},1032,["title"])])),_:2},1024),g(M,{align:"center"},{default:i((()=>[g(q,{class:"ellipsis",title:e.nickname},{default:i((()=>[h(_(e.nickname),1)])),_:2},1032,["title"])])),_:2},1024),g(M,{align:"center"},{default:i((()=>[g(q,{class:"ellipsis",title:e.cardCode},{default:i((()=>[h(_(e.cardCode),1)])),_:2},1032,["title"])])),_:2},1024),g(M,{align:"center"},{default:i((()=>[g(U,{text:S.formatCardType(e.cardType),type:S.getCardTypeTag(e.cardType)},null,8,["text","type"])])),_:2},1024),g(M,{align:"center"},{default:i((()=>[h(_(S.formatCardValue(e.cardType,e.cardValue)),1)])),_:2},1024),g(M,{align:"center"},{default:i((()=>[h(_(S.formatTime(e.redeemTime)),1)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1032,["loading","emptyText"]),g(q,{class:"uni-pagination-box"},{default:i((()=>[g(L,{"show-icon":"","show-page-size":"","page-size":e.size,modelValue:e.current,"onUpdate:modelValue":a=>e.current=a,total:e.count,onChange:S.onPageChanged,onPageSizeChange:S.changeSize},null,8,["page-size","modelValue","onUpdate:modelValue","total","onChange","onPageSizeChange"])])),_:2},1024)])),_:1},8,["where","page-size","page-current","orderby","onLoad"])])),_:1})])),_:1})}],["__scopeId","data-v-18c4b641"]]);export{V as default};
