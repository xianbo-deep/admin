import{_ as e,e as a,N as t,s as r,H as m,O as l,q as o,r as s,a as i,c as n,w as d,i as u,aD as f,o as h,h as p,k as c,L as D,j as b,l as g,F as y,u as T,V,p as v,Z as _}from"./index-1tsbwzWw.js";import{_ as w}from"./uni-easyinput.B-y-wvYA.js";import{_ as U}from"./uni-forms-item.C04_D_PQ.js";import{_ as x}from"./uni-data-select.ZmgLG0mc.js";import{_ as S}from"./uni-forms.Cx-ojO0j.js";const k=a.database();const E=e({data:()=>({formDataId:"",showPassword:!1,formData:{userId:"",nickname:"",avatarUrl:"",password:void 0,phone:"",email:"",status:"active",bio:"",registerTime:0,lastLoginTime:0,token:"",memberStatus:"none",membertype:"none",remainingDays:0,remainingTimes:0,usedTrial:!1,memberStartTime:0,memberExpireTime:0},rules:{userId:{rules:[{required:!0,errorMessage:"用户ID不能为空"}]},nickname:{rules:[{required:!0,errorMessage:"用户昵称不能为空"}]},avatarUrl:{rules:[{required:!0,errorMessage:"头像URL不能为空"}]},email:{rules:[{required:!0,errorMessage:"电子邮件不能为空"},{format:"email",errorMessage:"电子邮件格式不正确"}]},phone:{rules:[{required:!0,errorMessage:"手机号码不能为空"},{pattern:/^1\d{10}$/,errorMessage:"手机号码格式不正确"}]},password:{rules:[{minLength:6,errorMessage:"密码长度不能小于6位"}]},remainingDays:{rules:[{validateFunction:(e,a,t,r)=>{"daily"!==t.membertype&&"monthly"!==t.membertype||!(void 0===a||Number(a)<0)?r():r("剩余天数必须大于或等于0")}}]},remainingTimes:{rules:[{validateFunction:(e,a,t,r)=>{"times"===t.membertype&&(void 0===a||Number(a)<0)?r("剩余次数必须大于或等于0"):r()}}]}},statusOptions:[{value:"active",text:"正常"},{value:"inactive",text:"未激活"},{value:"banned",text:"已禁用"}],memberTypeOptions:[{value:"none",text:"非会员"},{value:"daily",text:"日卡"},{value:"monthly",text:"月卡"},{value:"times",text:"次卡"}],memberStatusOptions:[{value:"none",text:"非会员"},{value:"active",text:"有效"},{value:"expired",text:"已过期"}]}),computed:{formattedRegisterTime(){return this.formatDateTime(this.formData.registerTime)},formattedLastLoginTime(){return this.formatDateTime(this.formData.lastLoginTime)}},onLoad(e){if(e.id)this.formDataId=e.id,this.getDetail(e.id);else{this.getOpenerEventChannel().on("editData",(e=>{e&&(this.formData={...this.formData,...e,password:void 0},this.formDataId=e.userId)}))}},methods:{onMemberTypeChange(e){const a=e;if("none"===a)this.formData.memberStatus="none",this.formData.remainingDays=0,this.formData.remainingTimes=0,this.formData.memberExpireTime=0,this.formData.memberStartTime=0,this.formData.usedTrial=!1;else if("none"===this.formData.memberStatus&&(this.formData.memberStatus="active",this.formData.memberStartTime||(this.formData.memberStartTime=Date.now()),!this.formData.memberExpireTime)){const e=new Date;"daily"===a?e.setDate(e.getDate()+30):("monthly"===a||"times"===a)&&e.setMonth(e.getMonth()+1),this.formData.memberExpireTime=e.getTime()}},onAvatarError(){this.formData.avatarUrl="/static/avatar.png"},trigger(){this.showPassword=!this.showPassword,this.showPassword||(this.formData.password=void 0)},formatDateTime(e){if(!e)return"";try{return new Date(e).toLocaleString("zh-CN",{timeZone:"Asia/Shanghai",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).replace(/\//g,"-")}catch(a){return console.error("时间格式化错误:",a),""}},getDetail(e){t({mask:!0}),console.log("查询ID:",e),k.collection("User").where(`userId == "${e}"`).get().then((e=>{console.log("查询结果:",e);const a=e.result.data[0];a?(this.formData=Object.assign({},this.formData,a),this.formData.memberStatus=this.formData.memberStatus||"none",this.formData.membertype=this.formData.membertype||"none",this.formData.remainingDays=this.formData.remainingDays||0,this.formData.remainingTimes=this.formData.remainingTimes||0,this.formData.usedTrial=!!this.formData.usedTrial,this.formData.memberStartTime=this.formData.memberStartTime||0,this.formData.memberExpireTime=this.formData.memberExpireTime||0):r({content:"未找到用户数据",showCancel:!1,success:()=>{m()}})})).catch((e=>{r({content:e.message||"请求服务失败",showCancel:!1})})).finally((()=>{l()}))},submitForm(){this.$refs.form.validate().then((e=>{t({title:"保存中...",mask:!0});const a={userId:this.formData.userId,nickname:this.formData.nickname,avatarUrl:this.formData.avatarUrl,email:this.formData.email,phone:this.formData.phone,status:this.formData.status,bio:this.formData.bio||"",memberStatus:this.formData.memberStatus,membertype:this.formData.membertype,remainingDays:Number(this.formData.remainingDays||0),remainingTimes:Number(this.formData.remainingTimes||0),usedTrial:!!this.formData.usedTrial,memberStartTime:this.formData.memberStartTime||0,memberExpireTime:this.formData.memberExpireTime||0};this.showPassword&&this.formData.password&&(a.password=this.formData.password),Object.keys(a).forEach((e=>{void 0===a[e]&&delete a[e]})),a._id&&delete a._id,console.log("更新数据:",a),k.collection("User").where(`userId == "${this.formData.userId}"`).update(a).then((()=>{o({title:"保存成功"});this.getOpenerEventChannel().emit("refreshData"),setTimeout((()=>m()),500)})).catch((e=>{r({content:e.message||"请求服务失败",showCancel:!1})})).finally((()=>{l()}))})).catch((e=>{console.error("表单验证错误:",e)}))}}},[["render",function(e,a,t,r,m,l){const o=u,k=s(i("uni-easyinput"),w),E=s(i("uni-forms-item"),U),I=T,C=s(i("uni-data-select"),x),L=s(i("uni-datetime-picker"),f),q=V,M=v,O=_,j=s(i("uni-forms"),S);return h(),n(o,{class:"uni-container"},{default:d((()=>[p(j,{ref:"form",modelValue:m.formData,"onUpdate:modelValue":a[18]||(a[18]=e=>m.formData=e),rules:m.rules,validateTrigger:"bind",onSubmit:e.submit},{default:d((()=>[p(o,{class:"section-title"},{default:d((()=>[c("基本信息")])),_:1}),p(E,{name:"userId",label:"用户ID",required:""},{default:d((()=>[p(k,{modelValue:m.formData.userId,"onUpdate:modelValue":a[0]||(a[0]=e=>m.formData.userId=e),clearable:!1,disabled:""},null,8,["modelValue"])])),_:1}),p(E,{name:"nickname",label:"用户昵称",required:""},{default:d((()=>[p(k,{modelValue:m.formData.nickname,"onUpdate:modelValue":a[1]||(a[1]=e=>m.formData.nickname=e),clearable:!1,placeholder:"请输入用户昵称"},null,8,["modelValue"])])),_:1}),p(E,{name:"avatarUrl",label:"头像URL",required:""},{default:d((()=>[p(o,{class:"avatar-container"},{default:d((()=>[p(I,{class:"avatar-preview",src:m.formData.avatarUrl||"/static/avatar.png",mode:"aspectFill",onError:l.onAvatarError},null,8,["src","onError"]),p(k,{modelValue:m.formData.avatarUrl,"onUpdate:modelValue":a[2]||(a[2]=e=>m.formData.avatarUrl=e),clearable:!1,placeholder:"请输入头像URL"},null,8,["modelValue"])])),_:1})])),_:1}),m.showPassword?(h(),n(E,{name:"password",label:"重置密码",key:"password"},{default:d((()=>[p(k,{modelValue:m.formData.password,"onUpdate:modelValue":a[3]||(a[3]=e=>m.formData.password=e),type:"password",clearable:!1,placeholder:"请输入新密码"},{default:d((()=>[p(o,{slot:"right",class:"cancel-reset-password-btn",onClick:l.trigger},{default:d((()=>[c("取消")])),_:1},8,["onClick"])])),_:1},8,["modelValue"])])),_:1})):(h(),n(E,{key:1,label:"重置密码"},{default:d((()=>[D("span",{class:"reset-password-btn",onClick:a[4]||(a[4]=(...e)=>l.trigger&&l.trigger(...e))},"点击重置密码")])),_:1})),p(E,{name:"phone",label:"手机号码",required:""},{default:d((()=>[p(k,{modelValue:m.formData.phone,"onUpdate:modelValue":a[5]||(a[5]=e=>m.formData.phone=e),clearable:!1,placeholder:"请输入手机号码"},null,8,["modelValue"])])),_:1}),p(E,{name:"email",label:"电子邮件",required:""},{default:d((()=>[p(k,{modelValue:m.formData.email,"onUpdate:modelValue":a[6]||(a[6]=e=>m.formData.email=e),clearable:!1,placeholder:"请输入电子邮件"},null,8,["modelValue"])])),_:1}),p(E,{name:"status",label:"账户状态",required:""},{default:d((()=>[p(C,{modelValue:m.formData.status,"onUpdate:modelValue":a[7]||(a[7]=e=>m.formData.status=e),localdata:m.statusOptions,clear:!1},null,8,["modelValue","localdata"])])),_:1}),p(E,{name:"bio",label:"用户简介"},{default:d((()=>[p(k,{modelValue:m.formData.bio,"onUpdate:modelValue":a[8]||(a[8]=e=>m.formData.bio=e),type:"textarea",clearable:!1,placeholder:"请输入用户简介"},null,8,["modelValue"])])),_:1}),p(o,{class:"section-title"},{default:d((()=>[c("会员信息")])),_:1}),p(E,{name:"membertype",label:"会员卡类型"},{default:d((()=>[p(C,{modelValue:m.formData.membertype,"onUpdate:modelValue":a[9]||(a[9]=e=>m.formData.membertype=e),localdata:m.memberTypeOptions,clear:!1,onChange:l.onMemberTypeChange},null,8,["modelValue","localdata","onChange"])])),_:1}),p(E,{name:"memberStatus",label:"会员状态"},{default:d((()=>[p(C,{modelValue:m.formData.memberStatus,"onUpdate:modelValue":a[10]||(a[10]=e=>m.formData.memberStatus=e),localdata:m.memberStatusOptions,clear:!1},null,8,["modelValue","localdata"])])),_:1}),"daily"===m.formData.membertype||"monthly"===m.formData.membertype?(h(),n(E,{key:2,name:"remainingDays",label:"剩余天数"},{default:d((()=>[p(k,{modelValue:m.formData.remainingDays,"onUpdate:modelValue":a[11]||(a[11]=e=>m.formData.remainingDays=e),type:"number",clearable:!1,placeholder:"请输入剩余天数"},null,8,["modelValue"])])),_:1})):b("",!0),"times"===m.formData.membertype?(h(),n(E,{key:3,name:"remainingTimes",label:"剩余次数"},{default:d((()=>[p(k,{modelValue:m.formData.remainingTimes,"onUpdate:modelValue":a[12]||(a[12]=e=>m.formData.remainingTimes=e),type:"number",clearable:!1,placeholder:"请输入剩余次数"},null,8,["modelValue"])])),_:1})):b("",!0),"none"!==m.formData.membertype?(h(),g(y,{key:4},[p(E,{name:"memberStartTime",label:"会员开始时间"},{default:d((()=>[p(L,{modelValue:m.formData.memberStartTime,"onUpdate:modelValue":a[13]||(a[13]=e=>m.formData.memberStartTime=e),type:"datetime","return-type":"timestamp"},null,8,["modelValue"])])),_:1}),p(E,{name:"memberExpireTime",label:"会员到期时间"},{default:d((()=>[p(L,{modelValue:m.formData.memberExpireTime,"onUpdate:modelValue":a[14]||(a[14]=e=>m.formData.memberExpireTime=e),type:"datetime","return-type":"timestamp"},null,8,["modelValue"])])),_:1}),p(E,{name:"usedTrial",label:"是否体验卡"},{default:d((()=>[p(q,{checked:m.formData.usedTrial,onChange:a[15]||(a[15]=e=>m.formData.usedTrial=e.detail.value)},null,8,["checked"])])),_:1})],64)):b("",!0),p(o,{class:"section-title"},{default:d((()=>[c("时间信息")])),_:1}),p(E,{name:"registerTime",label:"注册时间"},{default:d((()=>[p(k,{modelValue:l.formattedRegisterTime,"onUpdate:modelValue":a[16]||(a[16]=e=>l.formattedRegisterTime=e),disabled:""},null,8,["modelValue"])])),_:1}),p(E,{name:"lastLoginTime",label:"最后登录"},{default:d((()=>[p(k,{modelValue:l.formattedLastLoginTime,"onUpdate:modelValue":a[17]||(a[17]=e=>l.formattedLastLoginTime=e),disabled:""},null,8,["modelValue"])])),_:1}),p(o,{class:"uni-button-group"},{default:d((()=>[p(M,{style:{width:"100px"},type:"primary",class:"uni-button",onClick:l.submitForm},{default:d((()=>[c("提交")])),_:1},8,["onClick"]),p(O,{"open-type":"navigateBack",style:{"margin-left":"15px"}},{default:d((()=>[p(M,{style:{width:"100px"},class:"uni-button"},{default:d((()=>[c("返回")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue","rules","onSubmit"])])),_:1})}],["__scopeId","data-v-4b6dff69"]]);export{E as default};
