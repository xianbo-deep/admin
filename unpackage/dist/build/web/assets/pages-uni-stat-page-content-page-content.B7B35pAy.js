import{_ as e,z as t,e as a,N as i,q as l,s as n,O as s,r as o,a as r,c as u,w as d,i as p,aG as c,B as m,b as g,d as h,f,g as _,a5 as y,o as b,h as v,A as D,j as q,k as C,l as k,m as T,F as V,p as x,ap as w,t as z}from"./index-BQ2OFzYe.js";import{_ as P}from"./uni-stat-breadcrumb.DHkfubMW.js";import{_ as j}from"./uni-data-select.B2KmuFFT.js";import{_ as S}from"./uni-stat-tabs.9lUfRSH-.js";import{_ as B}from"./uni-stat-panel.h9gMPIgm.js";import{_ as M}from"./uni-tooltip.BxzGFlvB.js";import{_ as A}from"./uni-pagination.Bz9-uLqg.js";import{_ as I}from"./uni-popup-dialog.Dd--rJwc.js";import{s as O,d as U,g as N,a as Q,b as F,m as G}from"./util.DxiA__Tf.js";const $=[{title:"内容统计页面",field:"page_link",stat:-1},{title:"页面名称",field:"page_title",stat:-1},{title:"访问次数",field:"visit_times",tooltip:"访问过应用内任意页面总次数，多个页面之间跳转、同一页面的重复访问计为多次访问；",value:0},{title:"访问设备数",field:"visit_devices",tooltip:"访问过应用内任意页面总次数，多个页面之间跳转、同一页面的重复访问计为多次访问；",value:0},{title:"次均停留时长",field:"avg_device_session_time",computed:"duration/visit_times",formatter:":",tooltip:"平均每次打开应用停留在应用内的总时长，即应用停留总时长/启动次数",value:0},{title:"设备平均停留时长",field:"avg_user_time",computed:"duration/visit_devices",formatter:":",tooltip:"平均每个设备停留在应用内的总时长，即应用停留总时长/访问设备数",value:0},{title:"分享次数",field:"share_count",tooltip:"页面被分享成功的次数",value:0}];const J=e({data:()=>({fieldsMap:$,query:{dimension:"day",appid:"",platform_id:"",uni_platform:"",version_id:"",channel_id:"",start_time:[]},options:{pageSize:20,pageCurrent:1,total:0},loading:!1,currentDateTab:1,tableData:[],panelData:$.filter((e=>e.hasOwnProperty("value"))),queryId:"",updateValue:"",channelData:[],errorMessage:""}),computed:{channelQuery(){const e=this.query.platform_id;return O({platform_id:e})},versionQuery(){const{appid:e,uni_platform:t}=this.query;return O({appid:e,uni_platform:t})}},created(){this.debounceGet=U((()=>this.getAllData())),this.getChannelData()},watch:{query:{deep:!0,handler(e){this.options.pageCurrent=1,this.debounceGet()}}},methods:{pageTo(e){t({url:e})},useDatetimePicker(){this.currentDateTab=-1},changeAppid(e){this.getChannelData(e,!1)},changePlatform(e,t,a,i){this.getChannelData(null,e),this.query.version_id=0,this.query.uni_platform=i.code},changeTimeRange(e,t){this.currentDateTab=t;const a=N(e),i=N(0)-1;this.query.start_time=[a,i]},changePageCurrent(e){this.options.pageCurrent=e.current,this.getTableData(this.query)},changePageSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.getTableData()},getAllData(){this.getPanelData(),this.getTableData()},getTableData(e){if(!this.query.appid)return void(this.errorMessage="请先选择应用");this.errorMessage="",e=O(this.query,null,["uni_platform"]);const{pageCurrent:t}=this.options;this.loading=!0;const i=a.database(),l=O({appid:this.query.appid}),n=i.collection("uni-stat-page-details").where(l).getTemp(),s=i.collection("uni-stat-page-detail-result").where(e).getTemp();i.collection(s,n).field(`${Q($)}, stat_date, page_detail_id`).groupBy("page_detail_id").groupField(F($)).orderBy("visit_times desc").skip((t-1)*this.options.pageSize).limit(this.options.pageSize).get({getCount:!0}).then((e=>{const{count:t,data:a}=e.result;this.options.total=t,this.tableData=[];for(const i of a){const e=i.page_detail_id;if(Array.isArray(e)){delete i.page_detail_id;const t=e[0];if(t&&Object.keys(t).length)for(const e in t)"_id"!==e&&(i[e]=t[e])}G($,i,i),this.tableData.push(i)}})).catch((e=>{console.error(e)})).finally((()=>{this.loading=!1}))},getPanelData(e=O(this.query,null,["uni_platform"])){let t=JSON.parse(JSON.stringify($));t=t.filter((e=>"visit_devices"!==e.field));a.database().collection("uni-stat-page-detail-result").where(e).field(Q(t)).groupBy("appid").groupField(F(t)).orderBy("start_time desc").get().then((e=>{const a=e.result.data[0];this.panelData=[],this.panelData=G(t,a)}))},inputDialogToggle(e,t){this.queryId=e,this.updateValue=t,this.$refs.inputDialog.open()},editName(e=""){const t=a.database();i({title:"请求中..."}),t.collection("uni-stat-page-details").where({page_link:this.queryId}).update({page_title:e.trim()}).then((e=>{e.result.updated?(l({title:"修改成功"}),this.getTableData()):l({title:"修改失败",icon:"none"})})).catch((e=>{n({content:e.message||"请求服务失败",showCancel:!1})})).finally((()=>{s()}))},getChannelData(e,t){this.query.channel_id="";const i=a.database(),l={};(e=e||this.query.appid)&&(l.appid=e),(t=t||this.query.platform_id)&&(l.platform_id=t);let n=i.collection("uni-stat-app-platforms").field("_id, name").getTemp(),s=i.collection("uni-stat-app-channels").where(l).field("_id, channel_name, create_time, platform_id").getTemp();i.collection(s,n).orderBy("platform_id asc").get().then((e=>{let t=e.result.data,a=[];if(t.length>0){let e;for(let i in t)e=t[i].channel_name?t[i].channel_name:"默认",t[i].platform_id.length>0&&(e=t[i].platform_id[0].name+"-"+e),a.push({value:t[i]._id,text:e})}this.channelData=a})).catch((e=>{console.error(e)})).finally((()=>{}))}}},[["render",function(e,t,a,i,l,n){const s=o(r("uni-stat-breadcrumb"),P),O=p,U=o(r("uni-data-select"),j),N=o(r("uni-stat-tabs"),S),Q=o(r("uni-datetime-picker"),c),F=o(r("uni-stat-panel"),B),G=x,$=o(r("uni-icons"),m),J=o(r("uni-tooltip"),M),R=o(r("uni-th"),g),L=o(r("uni-tr"),h),Z=o(r("uni-td"),f),E=o(r("uni-table"),_),H=o(r("uni-pagination"),A),K=o(r("uni-popup-dialog"),I),W=o(r("uni-popup"),y);return b(),u(O,{class:"fix-top-window"},{default:d((()=>[v(O,{class:"uni-header"},{default:d((()=>[v(s,{class:"uni-stat-breadcrumb-on-phone"}),v(O,{class:"uni-group"})])),_:1}),v(O,{class:"uni-container"},{default:d((()=>[v(O,{class:"uni-stat--x flex p-1015"},{default:d((()=>[v(O,{class:"uni-stat--app-select"},{default:d((()=>[v(U,{collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",modelValue:l.query.appid,"onUpdate:modelValue":t[0]||(t[0]=e=>l.query.appid=e),clear:!1},null,8,["modelValue"]),v(U,{collection:"opendb-app-versions",where:n.versionQuery,class:"ml-m",field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:l.query.version_id,"onUpdate:modelValue":t[1]||(t[1]=e=>l.query.version_id=e)},null,8,["where","modelValue"])])),_:1})])),_:1}),v(O,{class:"uni-stat--x flex"},{default:d((()=>[v(N,{label:"日期选择",current:l.currentDateTab,mode:"date",onChange:n.changeTimeRange},null,8,["current","onChange"]),v(Q,{type:"datetimerange",end:(new Date).getTime(),modelValue:l.query.start_time,"onUpdate:modelValue":t[2]||(t[2]=e=>l.query.start_time=e),returnType:"timestamp",clearIcon:!1,class:D(["uni-stat-datetime-picker",{"uni-stat__actived":l.currentDateTab<0&&!!l.query.start_time.length}]),onChange:n.useDatetimePicker},null,8,["end","modelValue","class","onChange"])])),_:1}),v(O,{class:"uni-stat--x"},{default:d((()=>[v(N,{label:"平台选择",type:"boldLine",mode:"platform",modelValue:l.query.platform_id,"onUpdate:modelValue":t[3]||(t[3]=e=>l.query.platform_id=e),onChange:n.changePlatform},null,8,["modelValue","onChange"]),l.query.platform_id&&-1===l.query.platform_id.indexOf("==")?(b(),u(U,{key:0,ref:"version-select",collection:"uni-stat-app-channels",where:n.channelQuery,class:"p-channel",field:"_id as value, channel_name as text",orderby:"text asc",label:"渠道/场景值选择",modelValue:l.query.channel_id,"onUpdate:modelValue":t[4]||(t[4]=e=>l.query.channel_id=e)},null,8,["where","modelValue"])):q("",!0)])),_:1}),v(F,{items:l.panelData},null,8,["items"]),v(O,{class:"uni-stat--x p-m"},{default:d((()=>[v(O,{class:"uni-stat-right-btn"},{default:d((()=>[v(G,{type:"primary",size:"mini",onClick:t[5]||(t[5]=e=>n.pageTo("/pages/uni-stat/page-rule/page-rule"))},{default:d((()=>[C("页面规则")])),_:1})])),_:1}),v(E,{loading:l.loading,border:"",stripe:"",emptyText:l.errorMessage||e.$t("common.empty")},{default:d((()=>[v(L,null,{default:d((()=>[(b(!0),k(V,null,T(l.fieldsMap,((e,t)=>(b(),k(V,{key:t},[e.title?(b(),u(R,{key:t,align:"center"},{default:d((()=>[v(J,null,w({default:d((()=>[C(z(e.title)+" ",1),0===t&&e.tooltip?(b(),u($,{key:0,type:"help",color:"#666"})):q("",!0)])),_:2},[0===t&&e.tooltip?{name:"content",fn:d((()=>[v(O,{class:"uni-stat-tooltip-s"},{default:d((()=>[C(z(e.tooltip),1)])),_:2},1024)])),key:"0"}:void 0]),1024)])),_:2},1024)):q("",!0)],64)))),128))])),_:1}),(b(!0),k(V,null,T(l.tableData,((e,t)=>(b(),u(L,{key:t},{default:d((()=>[(b(!0),k(V,null,T(l.fieldsMap,((t,a)=>(b(),k(V,{key:a},[1===a?(b(),u(Z,{key:t.field,class:"uni-stat-edit--x"},{default:d((()=>[C(z(void 0!==e[t.field]?e[t.field]:"-")+" ",1),v($,{type:"compose",color:"#2979ff",size:"25",class:"uni-stat-edit--btn",onClick:t=>n.inputDialogToggle(e.page_link,e.page_title)},null,8,["onClick"])])),_:2},1024)):(b(),u(Z,{key:t.field,align:0===a?"left":"center"},{default:d((()=>[C(z(void 0!==e[t.field]?e[t.field]:"-"),1)])),_:2},1032,["align"]))],64)))),128))])),_:2},1024)))),128))])),_:1},8,["loading","emptyText"]),v(O,{class:"uni-pagination-box"},{default:d((()=>[v(H,{"show-icon":"","show-page-size":"","page-size":l.options.pageSize,current:l.options.pageCurrent,total:l.options.total,onChange:n.changePageCurrent,onPageSizeChange:n.changePageSize},null,8,["page-size","current","total","onChange","onPageSizeChange"])])),_:1})])),_:1})])),_:1}),v(W,{ref:"inputDialog",type:"dialog",maskClick:!0},{default:d((()=>[v(K,{ref:"inputClose",mode:"input",title:"请编辑名称",modelValue:l.updateValue,"onUpdate:modelValue":t[6]||(t[6]=e=>l.updateValue=e),placeholder:"请输入内容",onConfirm:n.editName},null,8,["modelValue","onConfirm"])])),_:1},512)])),_:1})}],["__scopeId","data-v-132c5664"]]);export{J as default};
