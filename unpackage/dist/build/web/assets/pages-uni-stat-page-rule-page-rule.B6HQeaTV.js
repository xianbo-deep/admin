import{_ as e,e as a,n as t,r as l,a as i,c as s,w as n,i as d,b as o,d as u,f as r,g as p,B as c,a5 as f,o as g,h,k as m,l as _,m as y,F as b,I as P,p as R,t as x,v as C}from"./index-BQ2OFzYe.js";import{_ as I}from"./uni-stat-breadcrumb.DHkfubMW.js";import{_ as k}from"./uni-data-select.B2KmuFFT.js";import{_ as $}from"./uni-pagination.Bz9-uLqg.js";import{_ as w}from"./unicloud-db.C6t2K4BA.js";import{_ as z}from"./uni-notice-bar.DNmZZDX-.js";const v={};const V=a.database(),D=["title","path"],L={ascending:"asc",descending:"desc"};const E=e({data:()=>({collectionList:"uni-stat-pages",appid:"",query:"",where:"",orderby:"",orderByFieldName:"",selectedIndexs:[],errorMessage:"",options:{pageSize:20,pageCurrent:1,filterData:{},...v},imageStyles:{width:64,height:64},exportExcel:{filename:"uni-stat-pages.xls",type:"xls",fields:{title:"title",path:"path"}},exportExcelData:[],pageInfo:{_id:"",page_rules:[]},editRulePopup:{loading:!1,tips:"页面规则说明：\n1. 用于生成内容统计 url 的规则。通过设置页面有效参数，通过带参数的 url 对内容进行标识。例如有一个详情页面的请求有三个参数 page/detail/detail?id=1&type=1&t=1565943419，其中 t 为时间戳或随机数，则 id 和 type 为有效参数，需要在页面规则 page/detail/detail 中添加 id,type 这两个参数。\n2. 每条规则可以添加多个参数，进行匹配时，每条规则单独生效。\n3. 每个页面可以添加多个规则（最多 5 个规则），进行匹配时，后添加的规则优先级较高\n4. 目前的匹配规则只能处理通过 url 显式传递参数，且参数形式为上述示例中的键值对格式。",isAddParam:!1,addParamInfo:{index1:"",value:""}}}),onLoad(){this._filter={}},onReady(){this.$refs.appListRef&&(this.appid=this.$refs.appListRef.getCache(),this.search())},methods:{onqueryload(e){this.exportExcelData=e},getWhere(){const e=this.query.trim();let a="";if(e){const t=new RegExp(e,"i");a=D.map((e=>t+".test("+e+")")).join(" || ")}return this.appid&&(a=e?`appid=='${this.appid}' && (${a})`:`appid=='${this.appid}'`),a},search(){this.errorMessage="";const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs.length=0,this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},navigateTo(e,a){t({url:e,events:{refreshData:()=>{this.loadData(a)}}})},sortChange(e,a){this.orderByFieldName=a,e.order?this.orderby=a+" "+L[e.order]:this.orderby="",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},filterChange(e,a){this._filter[a]={type:e.filterType,value:e.filter};let t=function(e,a){let t={};for(let l in e){let{type:i,value:s}=e[l];switch(i){case"search":"string"==typeof s&&s.length&&(t[l]=new RegExp(s));break;case"select":if(s.length){let e=[];for(let t of s)e.push(a.eq(t));t[l]=a.or(e)}break;case"range":if(s.length){let e=s[0],i=s[1];t[l]=a.and([a.gte(e),a.lte(i)])}break;case"date":if(s.length){let[e,i]=s,n=new Date(e),d=new Date(i);t[l]=a.and([a.gte(n),a.lte(d)])}break;case"timestamp":if(s.length){let[e,i]=s;t[l]=a.and([a.gte(e),a.lte(i)])}}}return t}(this._filter,V.command);Object.keys(t).length?this.where=t:this.where="",this.$nextTick((()=>{this.$refs.udb.loadData()}))},editRule(e){this.$refs.editRulePopup.open(),e.page_rules&&e.page_rules.length||(e.page_rules=[[]]),this.pageInfo={_id:e._id,page_rules:JSON.parse(JSON.stringify(e.page_rules))}},addRulesItem(){this.pageInfo.page_rules.unshift([])},deleteRulesItem(e){this.pageInfo.page_rules.splice(e,1)},addParamItem(e){this.editRulePopup.isAddParam=!0,this.editRulePopup.addParamInfo.value="",this.editRulePopup.addParamInfo.index1=e},confirmAddParamItem(e){this.editRulePopup.addParamInfo.value&&this.pageInfo.page_rules[e].push(this.editRulePopup.addParamInfo.value),this.editRulePopup.isAddParam=!1},deleteParamItem(e,a){this.pageInfo.page_rules[e].splice(a,1)},closeEditRulePopup(){this.$refs.editRulePopup.close()},saveRule(){this.editRulePopup.loading=!0;let e=JSON.parse(JSON.stringify(this.pageInfo.page_rules));e=e.filter((e=>e.length>0)),this.$refs.udb.update(this.pageInfo._id,{page_rules:e},{showToast:!1,needLoading:!1,success:()=>{this.$refs.udb.dataList.forEach((a=>{a._id===this.pageInfo._id&&(a.page_rules=e)})),this.closeEditRulePopup()},complete:()=>{this.editRulePopup.loading=!1}})}}},[["render",function(e,a,t,v,V,D){const L=l(i("uni-stat-breadcrumb"),I),E=P,S=R,j=d,T=l(i("uni-data-select"),k),q=l(i("uni-th"),o),A=l(i("uni-tr"),u),F=l(i("uni-td"),r),N=l(i("uni-table"),p),U=l(i("uni-pagination"),$),B=l(i("unicloud-db"),w),O=l(i("uni-notice-bar"),z),J=C,M=l(i("uni-icons"),c),W=l(i("uni-popup"),f);return g(),s(j,null,{default:n((()=>[h(j,{class:"uni-header"},{default:n((()=>[h(L,{class:"uni-stat-breadcrumb-on-phone"}),h(j,{class:"uni-group"},{default:n((()=>[h(E,{class:"uni-search",type:"text",modelValue:V.query,"onUpdate:modelValue":a[0]||(a[0]=e=>V.query=e),onConfirm:D.search,placeholder:"请输入搜索内容"},null,8,["modelValue","onConfirm"]),h(S,{class:"uni-button",type:"default",size:"mini",onClick:D.search},{default:n((()=>[m("搜索")])),_:1},8,["onClick"])])),_:1})])),_:1}),h(j,{class:"uni-container"},{default:n((()=>[h(j,{class:"uni-stat--x flex p-1015"},{default:n((()=>[h(j,{class:"uni-stat--app-select",style:{width:"500px"}},{default:n((()=>[h(T,{ref:"appListRef",collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",label:"应用选择",modelValue:V.appid,"onUpdate:modelValue":a[1]||(a[1]=e=>V.appid=e),onChange:D.search},null,8,["modelValue","onChange"])])),_:1})])),_:1}),h(B,{ref:"udb",collection:V.collectionList,field:"title,path,page_rules,appid",where:V.where,"page-data":"replace",orderby:V.orderby,getcount:!0,"page-size":V.options.pageSize,"page-current":V.options.pageCurrent,options:V.options,loadtime:"manual",onLoad:D.onqueryload},{default:n((({data:e,pagination:t,loading:l,error:i,options:d})=>[h(N,{ref:"table",loading:l,emptyText:V.errorMessage||i.message||"没有更多数据",border:"",stripe:""},{default:n((()=>[h(A,null,{default:n((()=>[h(q,{align:"center"},{default:n((()=>[m("序号")])),_:1}),h(q,{align:"center","filter-type":"search",onFilterChange:a[2]||(a[2]=e=>D.filterChange(e,"title"))},{default:n((()=>[m("页面标题")])),_:1}),h(q,{align:"left","filter-type":"search",onFilterChange:a[3]||(a[3]=e=>D.filterChange(e,"path"))},{default:n((()=>[m("页面URL")])),_:1}),h(q,{align:"center","filter-type":"search",onFilterChange:a[4]||(a[4]=e=>D.filterChange(e,"appid"))},{default:n((()=>[m("appid")])),_:1}),h(q,{align:"center"},{default:n((()=>[m("操作")])),_:1})])),_:1}),(g(!0),_(b,null,y(e,((e,a)=>(g(),s(A,{key:a},{default:n((()=>[h(F,{align:"center"},{default:n((()=>[m(x((t.current-1)*t.size+(a+1)),1)])),_:2},1024),h(F,{align:"center"},{default:n((()=>[m(x(e.title),1)])),_:2},1024),h(F,{align:"left"},{default:n((()=>[m(x(e.path),1)])),_:2},1024),h(F,{align:"center"},{default:n((()=>[m(x(e.appid),1)])),_:2},1024),h(F,{align:"center"},{default:n((()=>[h(j,{class:"uni-group"},{default:n((()=>[h(S,{onClick:a=>D.editRule(e),class:"uni-button",size:"mini",type:"primary"},{default:n((()=>[m("编辑规则")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1032,["loading","emptyText"]),h(j,{class:"uni-pagination-box"},{default:n((()=>[h(U,{"show-icon":"","page-size":t.size,modelValue:t.current,"onUpdate:modelValue":e=>t.current=e,total:t.count,onChange:D.onPageChanged},null,8,["page-size","modelValue","onUpdate:modelValue","total","onChange"])])),_:2},1024)])),_:1},8,["collection","where","orderby","page-size","page-current","options","onLoad"])])),_:1}),h(W,{ref:"editRulePopup",type:"center"},{default:n((()=>[h(j,{class:"edit-rule-popup"},{default:n((()=>[h(j,{class:"uni-title"},{default:n((()=>[m("页面规则")])),_:1}),h(j,{class:"edit-rule-popup-tips"},{default:n((()=>[h(O,{"font-size":12,text:V.editRulePopup.tips},null,8,["text"])])),_:1}),h(j,{class:"edit-rule-popup-list"},{default:n((()=>[(g(!0),_(b,null,y(V.pageInfo.page_rules,((e,t)=>(g(),s(j,{class:"edit-rule-popup-item",key:t},{default:n((()=>[h(j,{class:"name"},{default:n((()=>[m(" 规则 "+x(V.pageInfo.page_rules.length-t),1)])),_:2},1024),h(j,{class:"tags"},{default:n((()=>[(g(!0),_(b,null,y(e,((e,a)=>(g(),s(j,{class:"tags-item tags-item-text",key:a},{default:n((()=>[h(J,{class:"text"},{default:n((()=>[m(x(e),1)])),_:2},1024),m(),h(M,{class:"pointer",type:"closeempty",size:"12",color:"#42b983",onClick:e=>D.deleteParamItem(t,a)},null,8,["onClick"])])),_:2},1024)))),128)),h(j,{class:"tags-item tags-item-add"},{default:n((()=>[V.editRulePopup.addParamInfo.index1===t&&V.editRulePopup.isAddParam?(g(),s(E,{key:0,class:"tags-item-add-input",type:"text",modelValue:V.editRulePopup.addParamInfo.value,"onUpdate:modelValue":a[5]||(a[5]=e=>V.editRulePopup.addParamInfo.value=e),modelModifiers:{trim:!0},focus:V.editRulePopup.addParamInfo.index1===t&&V.editRulePopup.isAddParam,onBlur:e=>D.confirmAddParamItem(t),placeholder:"输入参数名"},null,8,["modelValue","focus","onBlur"])):(g(),s(S,{key:1,size:"mini",class:"tags-item-add-btn",onClick:e=>D.addParamItem(t)},{default:n((()=>[m(" + 添加参数 ")])),_:2},1032,["onClick"]))])),_:2},1024)])),_:2},1024),h(j,{class:"btn"},{default:n((()=>[0===t&&V.pageInfo.page_rules.length<5?(g(),s(M,{key:0,type:"plus",size:"28",class:"pointer",color:"#606266",onClick:D.addRulesItem},null,8,["onClick"])):(g(),s(M,{key:1,type:"minus",size:"28",class:"pointer",color:"#606266",onClick:e=>D.deleteRulesItem(t)},null,8,["onClick"]))])),_:2},1024)])),_:2},1024)))),128))])),_:1}),h(j,{class:"edit-rule-popup-btn"},{default:n((()=>[h(S,{class:"uni-button btn",type:"primary",size:"default",loading:V.editRulePopup.loading,disabled:V.editRulePopup.loading,onClick:D.saveRule},{default:n((()=>[m("保存")])),_:1},8,["loading","disabled","onClick"]),h(S,{class:"uni-button btn",type:"default",size:"default",onClick:D.closeEditRulePopup},{default:n((()=>[m("取消")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1},512)])),_:1})}],["__scopeId","data-v-abddef4f"]]);export{E as default};
