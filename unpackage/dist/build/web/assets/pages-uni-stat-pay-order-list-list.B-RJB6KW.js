import{_ as e,e as t,n as a,q as r,r as n,a as l,c as i,w as o,i as d,b as s,d as u,f,g as p,a5 as _,o as c,h,k as g,l as m,m as y,F as C,t as b,p as x,v as F}from"./index-BQ2OFzYe.js";import{_ as v}from"./uni-stat-breadcrumb.DHkfubMW.js";import{_ as D}from"./download-excel.B3nI_-gX.js";import{_ as S}from"./uni-stat-tabs.9lUfRSH-.js";import{_ as $}from"./uni-dateformat.C3vwkADr.js";import{_ as w}from"./uni-pagination.Bz9-uLqg.js";import{_ as V}from"./unicloud-db.C6t2K4BA.js";import{_ as k}from"./uni-easyinput.VVN8Z8n5.js";import{_ as I}from"./uni-forms-item.O5OP8sj5.js";import{_ as j}from"./uni-forms.CeWDBJu8.js";import{e as q,f as z}from"./uni-pay-orders.CqmY5J70.js";import{s as T}from"./util.DxiA__Tf.js";import"./uni-tooltip.BxzGFlvB.js";const U=t.importObject("uni-pay-co"),E=t.database(),R={ascending:"asc",descending:"desc"};const L=e({data:()=>({collectionList:"uni-pay-orders",query:{appid:"",platform_id:"",uni_platform:"",version:"",pay_date:[]},where:"",orderby:"create_date desc",orderByFieldName:"",selectedIndexs:[],filterDefaultValueUserId:"",refundFormData:{out_trade_no:"",max_refund_fee:"",refund_fee:"",refund_desc:""},refundFormRules:{refund_fee:{rules:[{required:!0,errorMessage:"退款金额必须>0"},{minimum:.01,maximum:0,errorMessage:"最大可退 {maximum} 元"}]},refund_desc:{rules:[{required:!0,errorMessage:"请输入退款原因"}]}},options:{pageSize:20,pageCurrent:1,filterData:{provider_localdata:[{text:"微信支付",value:"wxpay"},{text:"支付宝",value:"alipay"},{text:"苹果应用内支付",value:"appleiap"}],status_localdata:[{text:"已关闭",value:-1},{text:"未支付",value:0},{text:"已支付",value:1},{text:"已部分退款",value:2},{text:"已全额退款",value:3}]},...q},imageStyles:{width:64,height:64},exportExcel:{filename:"uni-pay-orders.xls",type:"xls",fields:{"用户ID":"user_id","用户昵称":"nickname","支付供应商":"provider","支付方式":"provider_pay_type","应用平台":"uni_platform","订单状态":"status","支付失败原因":"err_msg","订单类型":"type","业务系统订单号":"order_no","支付插件订单号":"out_trade_no","交易单号":"transaction_id","支付描述":"description","订单支付金额":"total_fee","订单退款金额":"refund_fee","当前退款笔数":"refund_count","退款详情":"refund_list","回调状态":"user_order_success","创建时间":"create_date","支付时间":"pay_date","异步通知时间":"notify_date","取消时间":"cancel_date","开放平台appid":"provider_appid","DCloud AppId":"appid","设备ID":"device_id","客户端IP":"client_ip",openid:"openid"}},exportExcelData:[]}),onLoad(e){this._filter={},e.user_id&&(this.filterDefaultValueUserId=e.user_id,this.filterChange({filterType:"search",filter:e.user_id},"user_id"))},onReady(){this.$refs.udb.loadData()},methods:{onqueryload(e){this.exportExcelData=e},getWhere(){let e="",{pay_date:t,appid:a,version:r,uni_platform:n}=this.query;return t&&2==t.length&&(e+=` && pay_date>=${t[0]} && pay_date<=${t[1]}`),a&&(e+=` && appid=='${a}'`),r&&(e+=` && stat_data.app_version=='${r}'`),n&&(e+=` && stat_data.platform=='${n}'`),e=e.substring(3).trim(),e},search(){const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs.length=0,this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},navigateTo(e,t){a({url:e,events:{refreshData:()=>{this.loadData(t)}}})},selectedItems(){let e=this.$refs.udb.dataList;return this.selectedIndexs.map((t=>e[t]._id))},delTable(){this.$refs.udb.remove(this.selectedItems(),{success:e=>{this.$refs.table.clearSelection()}})},selectionChange(e){this.selectedIndexs=e.detail.index},refundPopup(e,t){if(e){let{total_fee:e=0,refund_fee:a=0,out_trade_no:r}=t,n=Number(((e-a)/100).toFixed(2));this.refundFormData.max_refund_fee=n,this.refundFormData.refund_fee=n,this.refundFormData.out_trade_no=r,this.refundFormRules.refund_fee.rules[1].maximum=n,this.$refs.popup.open()}else this.refundFormData.max_refund_fee="",this.refundFormData.refund_fee="",this.refundFormData.out_trade_no="",this.refundFormRules.refund_fee.rules[1].maximum=0,this.$refs.popup.close()},async confirmRefund(e){let{total_fee:t=0,refund_fee:a=0,out_trade_no:n,refund_desc:l}=e;e.refund_fee=Number(e.refund_fee.toFixed(2)),this.$refs.refundForm.validate().then((async t=>{let i=Number(a);if(isNaN(i)||i<=0)return void r({title:"请输入正确的退款金额",icon:"none",success:()=>{setTimeout((()=>{this.confirmRefund(e)}),500)}});let o={out_trade_no:n,refund_fee:parseInt(100*i),refund_desc:l};(await U.refund(o)).errCode||(this.refundPopup(!1),this.loadData(!1))})).catch((e=>{}))},sortChange(e,t){this.orderByFieldName=t,e.order?this.orderby=t+" "+R[e.order]:this.orderby="",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},filterChange(e,t,a){a&&e.filter&&"object"==typeof e.filter&&("number"==typeof e.filter[0]&&(e.filter[0]=e.filter[0]/a),"number"==typeof e.filter[1]&&(e.filter[1]=e.filter[1]/a)),this._filter[t]={type:e.filterType,value:e.filter};let r=z(this._filter,E.command);Object.keys(r).length?this.where=r:this.where="",this.$nextTick((()=>{this.$refs.udb.loadData()}))},platformChange(e,t,a,r){this.query.version=0,this.query.uni_platform=r.code},nameFormat:e=>e.user_id?e.nickname?`${e.user_id}（${e.nickname}）`:e.user_id:"匿名用户",pageToUser(e){let{user_id:t}=e;a({url:`/pages/system/user/list?id=${t}`})}},watch:{query:{deep:!0,handler(e){this.search()}}},computed:{versionQuery(){const{appid:e,uni_platform:t}=this.query;return T({appid:e,uni_platform:t})}}},[["render",function(e,t,a,r,q,z){const T=n(l("uni-stat-breadcrumb"),v),U=d,E=x,R=n(l("download-excel"),D),L=n(l("uni-stat-tabs"),S),N=n(l("uni-th"),s),P=n(l("uni-tr"),u),M=n(l("uni-td"),f),O=F,W=n(l("uni-dateformat"),$),A=n(l("uni-table"),p),B=n(l("uni-pagination"),w),G=n(l("unicloud-db"),V),Q=n(l("uni-easyinput"),k),H=n(l("uni-forms-item"),I),J=n(l("uni-forms"),j),K=n(l("uni-popup"),_);return c(),i(U,null,{default:o((()=>[h(U,{class:"uni-header"},{default:o((()=>[h(U,{class:"uni-group"},{default:o((()=>[h(T)])),_:1}),h(U,{class:"uni-group"},{default:o((()=>[h(E,{class:"uni-button",type:"default",size:"mini",onClick:z.search},{default:o((()=>[g("搜索")])),_:1},8,["onClick"]),h(R,{class:"hide-on-phone",fields:q.exportExcel.fields,data:q.exportExcelData,type:q.exportExcel.type,name:q.exportExcel.filename},{default:o((()=>[h(E,{class:"uni-button",type:"primary",size:"mini"},{default:o((()=>[g("导出 Excel")])),_:1})])),_:1},8,["fields","data","type","name"])])),_:1})])),_:1}),h(U,{class:"uni-container"},{default:o((()=>[h(U,{class:"uni-stat--x"},{default:o((()=>[h(L,{label:"平台选择",type:"boldLine",mode:"platform",modelValue:q.query.platform,"onUpdate:modelValue":t[0]||(t[0]=e=>q.query.platform=e),onChange:z.platformChange},null,8,["modelValue","onChange"])])),_:1}),h(G,{ref:"udb",collection:q.collectionList,field:"user_id,nickname,provider,provider_pay_type,uni_platform,status,type,order_no,out_trade_no,transaction_id,device_id,client_ip,openid,description,err_msg,total_fee,refund_fee,refund_count,refund_list,provider_appid,appid,user_order_success,create_date,pay_date,notify_date,cancel_date",where:q.where,"page-data":"replace",orderby:q.orderby,getcount:!0,"page-size":q.options.pageSize,"page-current":q.options.pageCurrent,options:q.options,loadtime:"manual",onLoad:z.onqueryload},{default:o((({data:e,pagination:a,loading:r,error:n,options:l})=>[h(A,{ref:"table",loading:r,emptyText:n.message||r?"请求中...":"没有更多数据",border:"",stripe:"",type:"",onSelectionChange:z.selectionChange,style:{"min-height":"900px"}},{default:o((()=>[h(P,null,{default:o((()=>[h(N,{align:"center"},{default:o((()=>[g("序号")])),_:1}),h(N,{ref:"user_id",align:"center",filterDefaultValue:q.filterDefaultValueUserId,"filter-type":"search",onFilterChange:t[1]||(t[1]=e=>z.filterChange(e,"user_id")),sortable:"",onSortChange:t[2]||(t[2]=e=>z.sortChange(e,"user_id"))},{default:o((()=>[g("用户")])),_:1},8,["filterDefaultValue"]),h(N,{align:"center","filter-type":"select","filter-data":l.filterData.provider_localdata,onFilterChange:t[3]||(t[3]=e=>z.filterChange(e,"provider"))},{default:o((()=>[g("支付供应商")])),_:2},1032,["filter-data"]),h(N,{align:"center","filter-type":"search",onFilterChange:t[4]||(t[4]=e=>z.filterChange(e,"provider_pay_type")),sortable:"",onSortChange:t[5]||(t[5]=e=>z.sortChange(e,"provider_pay_type"))},{default:o((()=>[g("支付方式")])),_:1}),h(N,{align:"center","filter-type":"search",onFilterChange:t[6]||(t[6]=e=>z.filterChange(e,"uni_platform")),sortable:"",onSortChange:t[7]||(t[7]=e=>z.sortChange(e,"uni_platform"))},{default:o((()=>[g("应用平台")])),_:1}),h(N,{align:"center","filter-type":"select","filter-data":l.filterData.status_localdata,onFilterChange:t[8]||(t[8]=e=>z.filterChange(e,"status"))},{default:o((()=>[g("订单状态")])),_:2},1032,["filter-data"]),h(N,{align:"center","filter-type":"search",onFilterChange:t[9]||(t[9]=e=>z.filterChange(e,"type")),sortable:"",onSortChange:t[10]||(t[10]=e=>z.sortChange(e,"type"))},{default:o((()=>[g("订单类型")])),_:1}),h(N,{align:"center","filter-type":"search",onFilterChange:t[11]||(t[11]=e=>z.filterChange(e,"order_no")),sortable:"",onSortChange:t[12]||(t[12]=e=>z.sortChange(e,"order_no"))},{default:o((()=>[g("业务系统订单号")])),_:1}),h(N,{align:"center","filter-type":"search",onFilterChange:t[13]||(t[13]=e=>z.filterChange(e,"out_trade_no")),sortable:"",onSortChange:t[14]||(t[14]=e=>z.sortChange(e,"out_trade_no"))},{default:o((()=>[g("支付插件订单号")])),_:1}),h(N,{align:"center","filter-type":"search",onFilterChange:t[15]||(t[15]=e=>z.filterChange(e,"transaction_id")),sortable:"",onSortChange:t[16]||(t[16]=e=>z.sortChange(e,"transaction_id"))},{default:o((()=>[g("交易单号")])),_:1}),h(N,{align:"center","filter-type":"search",onFilterChange:t[17]||(t[17]=e=>z.filterChange(e,"description")),sortable:"",onSortChange:t[18]||(t[18]=e=>z.sortChange(e,"description"))},{default:o((()=>[g("支付描述")])),_:1}),h(N,{align:"center","filter-type":"range",onFilterChange:t[19]||(t[19]=e=>z.filterChange(e,"total_fee",.01)),sortable:"",onSortChange:t[20]||(t[20]=e=>z.sortChange(e,"total_fee"))},{default:o((()=>[g("订单支付金额")])),_:1}),h(N,{align:"center","filter-type":"range",onFilterChange:t[21]||(t[21]=e=>z.filterChange(e,"refund_fee",.01)),sortable:"",onSortChange:t[22]||(t[22]=e=>z.sortChange(e,"refund_fee"))},{default:o((()=>[g("订单退款金额")])),_:1}),h(N,{align:"center","filter-type":"range",onFilterChange:t[23]||(t[23]=e=>z.filterChange(e,"refund_count")),sortable:"",onSortChange:t[24]||(t[24]=e=>z.sortChange(e,"refund_count"))},{default:o((()=>[g("当前退款笔数")])),_:1}),h(N,{align:"center",sortable:"",onSortChange:t[25]||(t[25]=e=>z.sortChange(e,"user_order_success"))},{default:o((()=>[g("回调状态")])),_:1}),h(N,{align:"center","filter-type":"timestamp",onFilterChange:t[26]||(t[26]=e=>z.filterChange(e,"create_date")),sortable:"",onSortChange:t[27]||(t[27]=e=>z.sortChange(e,"create_date"))},{default:o((()=>[g("创建时间")])),_:1}),h(N,{align:"center","filter-type":"timestamp",onFilterChange:t[28]||(t[28]=e=>z.filterChange(e,"pay_date")),sortable:"",onSortChange:t[29]||(t[29]=e=>z.sortChange(e,"pay_date"))},{default:o((()=>[g("支付时间")])),_:1}),h(N,{align:"center","filter-type":"timestamp",onFilterChange:t[30]||(t[30]=e=>z.filterChange(e,"cancel_date")),sortable:"",onSortChange:t[31]||(t[31]=e=>z.sortChange(e,"cancel_date"))},{default:o((()=>[g("取消时间")])),_:1}),h(N,{align:"center","filter-type":"search",onFilterChange:t[32]||(t[32]=e=>z.filterChange(e,"provider_appid")),sortable:"",onSortChange:t[33]||(t[33]=e=>z.sortChange(e,"provider_appid"))},{default:o((()=>[g("开放平台appid")])),_:1}),h(N,{align:"center","filter-type":"search",onFilterChange:t[34]||(t[34]=e=>z.filterChange(e,"appid")),sortable:"",onSortChange:t[35]||(t[35]=e=>z.sortChange(e,"appid"))},{default:o((()=>[g("DCloud AppId")])),_:1}),h(N,{align:"center","filter-type":"search",onFilterChange:t[36]||(t[36]=e=>z.filterChange(e,"device_id")),sortable:"",onSortChange:t[37]||(t[37]=e=>z.sortChange(e,"device_id"))},{default:o((()=>[g("设备ID")])),_:1}),h(N,{align:"center","filter-type":"search",onFilterChange:t[38]||(t[38]=e=>z.filterChange(e,"client_ip")),sortable:"",onSortChange:t[39]||(t[39]=e=>z.sortChange(e,"client_ip"))},{default:o((()=>[g("客户端IP")])),_:1}),h(N,{align:"center","filter-type":"search",onFilterChange:t[40]||(t[40]=e=>z.filterChange(e,"openid")),sortable:"",onSortChange:t[41]||(t[41]=e=>z.sortChange(e,"openid"))},{default:o((()=>[g("openid")])),_:1})])),_:2},1024),(c(!0),m(C,null,y(e,((e,t)=>(c(),i(P,{key:t},{default:o((()=>[h(M,{align:"center"},{default:o((()=>[g(b(parseInt(t+1+(a.current-1)*a.size)),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[h(O,{class:"text-btn",onClick:t=>z.pageToUser(e)},{default:o((()=>[g(b(z.nameFormat(e)),1)])),_:2},1032,["onClick"])])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b(l.provider_valuetotext[e.provider]),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b(e.provider_pay_type),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b(e.uni_platform),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b(l.status_valuetotext[e.status]),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b(e.type),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b(e.order_no),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b(e.out_trade_no),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b(e.transaction_id),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b(e.description),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b((.01*e.total_fee).toFixed(2)),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b((.01*e.refund_fee).toFixed(2)),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b(e.refund_count),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[!0===e.user_order_success?(c(),i(U,{key:0,style:{color:"#18bc37"}},{default:o((()=>[g("✔正常")])),_:1})):[-1,0].indexOf(e.status)>-1?(c(),i(U,{key:1},{default:o((()=>[g("-")])),_:1})):(c(),i(U,{key:2,style:{color:"#e43d33"}},{default:o((()=>[g("●异常")])),_:1}))])),_:2},1024),h(M,{align:"center"},{default:o((()=>[h(W,{threshold:[0,0],date:e.create_date},null,8,["date"])])),_:2},1024),h(M,{align:"center"},{default:o((()=>[h(W,{threshold:[0,0],date:e.pay_date},null,8,["date"])])),_:2},1024),h(M,{align:"center"},{default:o((()=>[h(W,{threshold:[0,0],date:e.cancel_date},null,8,["date"])])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b(e.provider_appid),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b(e.appid),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b(e.device_id),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b(e.client_ip),1)])),_:2},1024),h(M,{align:"center"},{default:o((()=>[g(b(e.openid),1)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1032,["loading","emptyText","onSelectionChange"]),h(U,{class:"uni-pagination-box"},{default:o((()=>[h(B,{"show-icon":"","page-size":a.size,modelValue:a.current,"onUpdate:modelValue":e=>a.current=e,total:a.count,onChange:z.onPageChanged},null,8,["page-size","modelValue","onUpdate:modelValue","total","onChange"])])),_:2},1024)])),_:1},8,["collection","where","orderby","page-size","page-current","options","onLoad"])])),_:1}),h(K,{ref:"popup",type:"center",animation:!1},{default:o((()=>[h(U,{style:{padding:"30px","background-color":"#ffffff",width:"500px"}},{default:o((()=>[h(U,{style:{"margin-bottom":"20px","text-align":"center","font-size":"20px","font-weight":"bold"}},{default:o((()=>[g("退款确认")])),_:1}),h(J,{ref:"refundForm",modelValue:q.refundFormData,"label-position":"left",labelWidth:"100px",rules:q.refundFormRules},{default:o((()=>[h(H,{label:"退款金额",name:"refund_fee"},{default:o((()=>[h(Q,{type:"text",modelValue:q.refundFormData.refund_fee,"onUpdate:modelValue":t[42]||(t[42]=e=>q.refundFormData.refund_fee=e),modelModifiers:{number:!0},placeholder:"请输入退款金额",clearable:!1},null,8,["modelValue"]),h(U,{style:{color:"#666","margin-top":"5px","font-size":"12px"}},{default:o((()=>[g("最大可退："+b(q.refundFormData.max_refund_fee),1)])),_:1})])),_:1}),h(H,{label:"退款原因",name:"refund_desc"},{default:o((()=>[h(Q,{type:"textarea",modelValue:q.refundFormData.refund_desc,"onUpdate:modelValue":t[43]||(t[43]=e=>q.refundFormData.refund_desc=e),placeholder:"请输入退款原因",clearable:!1},null,8,["modelValue"])])),_:1}),h(E,{type:"warn",style:{width:"100px",height:"40px","font-size":"16px"},onClick:t[44]||(t[44]=e=>{z.confirmRefund(q.refundFormData)})},{default:o((()=>[g("确定")])),_:1})])),_:1},8,["modelValue","rules"])])),_:1})])),_:1},512)])),_:1})}],["__scopeId","data-v-574dd5d2"]]);export{L as default};
