import{_ as e,e as t,n as a,r as s,a as r,c as i,w as o,i as l,aG as n,o as u,h as d,A as c,j as p,k as m}from"./index-BQ2OFzYe.js";import{_ as h}from"./uni-stat-breadcrumb.DHkfubMW.js";import{_}from"./uni-data-select.B2KmuFFT.js";import{_ as f}from"./uni-stat-tabs.9lUfRSH-.js";import{_ as g}from"./uni-stat-panel.h9gMPIgm.js";import{_ as b}from"./qiun-data-charts.LWZYy2wC.js";import{s as y,d as D,g as v,a as q,b as x,p as T,m as C,c as V,h as w}from"./util.DxiA__Tf.js";import"./uni-tooltip.BxzGFlvB.js";const F=[{value:"今天",contrast:"昨天"},{title:"新增用户",field:"new_user_count",tooltip:"首次访问应用的用户数（以用户为判断标准，去重）",value:0,contrast:0},{title:"活跃用户",field:"active_user_count",tooltip:"访问过应用内任意页面的总用户数，今日数据为每小时活跃用户累加（未虑重），昨日数据为全天活跃用户虑重后结果。",value:0,contrast:0},{title:"次均停留时长",field:"avg_user_session_time",computed:"duration/user_session_times",formatter:":",tooltip:"平均每次打开应用停留在应用内的总时长，即应用停留总时长/启动次数",value:0,contrast:0},{title:"人均停留时长 ",field:"avg_user_time",computed:"duration/active_user_count",formatter:":",tooltip:"平均每个用户停留在应用内的总时长，即应用停留总时长/活跃用户",value:0,contrast:0},{title:"总用户数",field:"total_users",tooltip:"从添加统计到当前选择时间的总用户数（去重）",value:0,contrast:0}],S=[{title:"受访页",field:"path",tooltip:"用户进入应用访问的所有页面，例如用户从页面1进入应用，跳转到页面2，1,2均为受访页",formatter:""},{title:"访问次数",field:"visit_times",tooltip:"访问该页面的总次数",value:0},{title:"占比",field:"rate",computed:"visit_times/total_app_access",tooltip:"某个页面的访问次数占所有页面访问次数的比例",formatter:"%"}],I=[{title:"入口页",field:"path",tooltip:"用户进入应用访问的第一个页面，例如用户从页面1进入应用，跳转到页面2，1为入口页，而2不是",formatter:""},{title:"访问次数",field:"entry_count",tooltip:"访问该页面的总次数",value:0},{title:"占比",field:"rate",computed:"entry_count/total_app_access",tooltip:"某个页面的访问次数占所有页面访问次数的比例",formatter:"%"}],N=F.filter((e=>e.hasOwnProperty("value")));const j=e({data:()=>({tableName:"uni-stat-result",fieldsMap:F,resFieldsMap:S,entFieldsMap:I,query:{dimension:"hour",appid:"",platform_id:"",uni_platform:"",version_id:"",start_time:[]},options:{pageCurrent:1,total:0,pageSizeIndex:0,pageSizeRange:[10,20,50,100]},loading:!1,currentDateTab:2,chartTab:"new_user_count",tableData:[],resTableData:[],entTableData:[],panelData:N,chartData:{},eopts:{seriesTemplate:[{itemStyle:{borderWidth:2,borderColor:"#1890FF",color:"#1890FF"},areaStyle:{color:{colorStops:[{offset:0,color:"#1890FF"},{offset:1,color:"#FFFFFF"}]}}},{lineStyle:{color:"#ea7ccc",width:2,type:"dashed"},itemStyle:{borderWidth:1,borderColor:"#ea7ccc",color:"#ea7ccc"},areaStyle:null}]},tabIndex:0,errorMessage:""}),onLoad(e){const{appid:t}=e;t&&(this.query.appid=t)},computed:{pageSize(){const{pageSizeRange:e,pageSizeIndex:t}=this.options;return e[t]},chartTabs(){const e=[];return F.forEach((t=>{const a=t.field,s=t.title;a&&s&&e.push({_id:a,name:s})})),e},versionQuery(){const{appid:e,uni_platform:t}=this.query;return y({appid:e,uni_platform:t})},channelQuery(){const{appid:e,platform_id:t}=this.query;return y({appid:e,platform_id:t})}},created(){this.debounceGet=D((()=>{this.getAllData(this.query)}),300)},watch:{query:{deep:!0,handler(e){this.options.pageCurrent=1,this.debounceGet()}}},methods:{useDatetimePicker(){this.currentDateTab=null},changePlatform(e,t,a,s){this.query.version_id=0,this.query.uni_platform=s.code},changeTimeRange(e,t){this.currentDateTab=t;let a,s;a=v(e),s=e?v(0)-1:v(0)+864e5-1,this.query.start_time=[a,s]},changePageCurrent(e){this.options.pageCurrent=e.current,this.getChartData(this.query)},changePageSize(e){const{value:t}=e.detail;this.options.pageCurrent=1,this.options.pageSizeIndex=t,this.getChartData(this.query)},changeChartTab(e,t,a){this.tabIndex=t,this.getChartData(this.query,e,a)},getAllData(e){e.appid?(this.errorMessage="",this.getPanelData(),this.getChartData(e)):this.errorMessage="请先选择应用"},getDays(){if(!this.query.start_time.length)return!0;const[e,t]=this.query.start_time;return t-e>=864e5},getPanelData(){const{appid:e,platform_id:a,version_id:s}=this.query,r=y({appid:e,platform_id:a,version_id:s,start_time:[v(1),(new Date).getTime()]});t.database().collection(this.tableName).where(r).field(`${q(F)},dimension,stat_date`).groupBy("stat_date, dimension").groupField(x(F)).orderBy("stat_date","desc").get().then((e=>{const t=e.result.data,a=t.find((e=>e.stat_date===T(v(0),"","")))||{};a.total_users=0;const s=t.find((e=>"day"===e.dimension&&e.stat_date===T(v(1),"","")));this.panelData=[],this.panelData=C(F,a),this.panelData.map((e=>{C(F,s,e,"","contrast")})),V.call(this,r,"total_users")}))},getChartData(e,a=this.chartTabs[this.tabIndex]._id,s=this.chartTabs[this.tabIndex].name){this.options;const r=this.currentDateTab,i=v(r),o=864e5;let l;if(!this.getDays()){const t=i-o,a=i+o-1;e=JSON.parse(JSON.stringify(e)),l=e.start_time=[t,a]}e=y(e,!0,["uni_platform"]);t.database().collection(this.tableName).where(e).field(`${q(F,a)}, start_time`).groupBy("start_time").groupField(x(F,a)).orderBy("start_time","asc").get({getCount:!0}).then((e=>{const{count:t,data:r}=e.result,o={categories:[],series:[{name:s,data:[]}]};let n=F.filter((e=>e.field===a));if(n=JSON.parse(JSON.stringify(n)),delete n[0].value,n[0].formatter="",this.getDays())for(const s of r){C(n,s,s);const e=w(s.start_time,"day");let t=Number(s[a]);o.series[0].data.push(t),o.categories.push(e)}else{const[e,t]=l,s=o.series[1]={name:w(e),data:[]},u=o.series[0]={name:w(t),data:[]};for(let l=0;l<24;++l){const e=l<10?"0"+l:l,t=`${e}:00 ~ ${e}:59`;o.categories.push(t),s.data[l]=0,u.data[l]=0,r.forEach((e=>{C(n,e,e);let t=Number(e[a]);const r=new Date(e.start_time);e.start_time<i?r.getHours()===l&&(s.data[l]=t):r.getHours()===l&&(u.data[l]=t)}))}}this.chartData=o})).catch((e=>{console.error(e)})).finally((()=>{}))},getAppAccessTimes(e){return t.database().collection(this.tableName).where(e).groupBy("appid").groupField("sum(page_visit_count) as total_app_access").get()},navTo(e){e&&a({url:e})}}},[["render",function(e,t,a,y,D,v){const q=s(r("uni-stat-breadcrumb"),h),x=l,T=s(r("uni-data-select"),_),C=s(r("uni-stat-tabs"),f),V=s(r("uni-datetime-picker"),n),w=s(r("uni-stat-panel"),g),F=s(r("qiun-data-charts"),b);return u(),i(x,{class:"fix-top-window"},{default:o((()=>[d(x,{class:"uni-header"},{default:o((()=>[d(q,{class:"uni-stat-breadcrumb-on-phone"})])),_:1}),d(x,{class:"uni-container"},{default:o((()=>[d(x,{class:"uni-stat--x flex p-1015"},{default:o((()=>[d(x,{class:"uni-stat--app-select"},{default:o((()=>[d(T,{collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",modelValue:D.query.appid,"onUpdate:modelValue":t[0]||(t[0]=e=>D.query.appid=e),clear:!1},null,8,["modelValue"]),d(T,{collection:"opendb-app-versions",where:v.versionQuery,class:"ml-m",field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:D.query.version_id,"onUpdate:modelValue":t[1]||(t[1]=e=>D.query.version_id=e)},null,8,["where","modelValue"])])),_:1})])),_:1}),d(x,{class:"uni-stat--x flex"},{default:o((()=>[d(C,{label:"日期选择",current:D.currentDateTab,mode:"date",today:!0,onChange:v.changeTimeRange},null,8,["current","onChange"]),d(V,{type:"datetimerange",end:(new Date).getTime(),modelValue:D.query.start_time,"onUpdate:modelValue":t[2]||(t[2]=e=>D.query.start_time=e),returnType:"timestamp",clearIcon:!1,class:c(["uni-stat-datetime-picker",{"uni-stat__actived":D.currentDateTab<0&&!!D.query.start_time.length}]),onChange:v.useDatetimePicker},null,8,["end","modelValue","class","onChange"])])),_:1}),d(x,{class:"uni-stat--x"},{default:o((()=>[d(C,{label:"平台选择",type:"boldLine",mode:"platform",modelValue:D.query.platform_id,"onUpdate:modelValue":t[3]||(t[3]=e=>D.query.platform_id=e),onChange:v.changePlatform},null,8,["modelValue","onChange"]),D.query.platform_id&&-1===D.query.platform_id.indexOf("==")?(u(),i(T,{key:0,ref:"version-select",collection:"uni-stat-app-channels",where:v.channelQuery,class:"p-channel",field:"_id as value, channel_name as text",orderby:"text asc",label:"渠道/场景值选择",modelValue:D.query.channel_id,"onUpdate:modelValue":t[4]||(t[4]=e=>D.query.channel_id=e)},null,8,["where","modelValue"])):p("",!0)])),_:1}),d(w,{items:D.panelData,contrast:!0},null,8,["items"]),d(x,{class:"uni-stat--x p-m"},{default:o((()=>[d(x,{class:"uni-stat-card-header"},{default:o((()=>[m(" 趋势图 ")])),_:1}),d(C,{type:"box",modelValue:D.chartTab,"onUpdate:modelValue":t[5]||(t[5]=e=>D.chartTab=e),tabs:v.chartTabs,class:"mb-l",onChange:v.changeChartTab},null,8,["modelValue","tabs","onChange"]),d(x,{class:"uni-charts-box"},{default:o((()=>[d(F,{type:"area",chartData:D.chartData,eopts:D.eopts,echartsH5:"",echartsApp:"",tooltipFormat:"tooltipCustom",errorMessage:D.errorMessage},null,8,["chartData","eopts","errorMessage"])])),_:1})])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-879a6a03"]]);export{j as default};
